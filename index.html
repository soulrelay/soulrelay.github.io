<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="手掌一散，流落走多少时光">
<meta property="og:type" content="website">
<meta property="og:title" content="SuS&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="SuS&#39;s Blog">
<meta property="og:description" content="手掌一散，流落走多少时光">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SuS&#39;s Blog">
<meta name="twitter:description" content="手掌一散，流落走多少时光">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>

  <title> SuS's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">SuS's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Much to Live For</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/03/发布Library到JCenter，步步为营/" itemprop="url">
                  发布Library到JCenter，步步为营
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-08-03T12:00:00+08:00" content="2017-08-03">
              2017-08-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/08/03/发布Library到JCenter，步步为营/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/03/发布Library到JCenter，步步为营/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>将自己写的库上传到Jcenter或者Maven提供给自己或者别人使用，在构建项目的时候只要写上一行如下类似的引用代码即可引用自己的库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile &apos;com.sus.library:imagelib:1.0.0&apos;</div></pre></td></tr></table></figure></p>
<p>看到这篇文章的同学可能之前已经踩了不少坑，希望下面的介绍可以帮你解惑<br>如果有什么问题欢迎提出！趁热乎哈！</p>
<p>下面将逐步介绍如何将Library发布到JCenter</p>
<p>具体案例为：<a href="https://github.com/soulrelay/ImageLoaderUtil" target="_blank" rel="external">ImageLoaderUtil</a><br>所有下文涉及到的文件和配置都包含在其中，如果你觉得对你有用，麻烦STAR一下</p>
<h3 id="1、进入Bintray官网"><a href="#1、进入Bintray官网" class="headerlink" title="1、进入Bintray官网"></a>1、进入<a href="https://bintray.com" target="_blank" rel="external">Bintray</a>官网</h3><p><img src="http://upload-images.jianshu.io/upload_images/1814304-c002779dfbdfcedf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240/h/620" alt="Bintray官网首页"></p>
<blockquote>
<ul>
<li>这里选择“For an Open Source Account Sign Up Here”,而非“START YOUR FREE TRIAL”，如果选择 “START YOUR FREE TRIAL”，可能会碰到下面的问题  <a href="https://stackoverflow.com/questions/41953886/bintray-link-to-jcenter-missing" target="_blank" rel="external">Bintray link to jcenter missing</a></li>
<li>问题结论就是：”Add To JCenter” is not enabled for Enterprise Trial users. You need to be OSS or Premium organization/user in order to link your packages to JCenter.</li>
</ul>
</blockquote>
<h3 id="2、注册账号"><a href="#2、注册账号" class="headerlink" title="2、注册账号"></a>2、注册账号</h3><p><img src="http://upload-images.jianshu.io/upload_images/1814304-a377bf8127073659.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240/h/620" alt="账号注册页面"><br>填写相关信息，邮箱尽量使用Gmail邮箱地址（国内邮箱有可能无法注册或者注册成功无法收到激活邮件），注册完成之后到你填写的邮箱里面去激活Bintray账号即可<br>举例：</p>
<blockquote>
<ul>
<li>First Name : Shuai</li>
<li>Last Name : Su</li>
<li>Username : su2008shuai</li>
<li>Password : xxxxxxxxxxxxxx</li>
<li>Emai Address : su2008shuai@gmail.com</li>
<li>Select Country : China</li>
</ul>
</blockquote>
<h3 id="3、创建代码仓库"><a href="#3、创建代码仓库" class="headerlink" title="3、创建代码仓库"></a>3、创建代码仓库</h3><p><img src="http://upload-images.jianshu.io/upload_images/1814304-50ecfd641940a7da.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240/h/620" alt="View Profile"></p>
<p>点击上图所示的“Add NewRepository”按钮，添加代码仓库，点击后就会跳转到下图的界面</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1814304-58552f3f7e61c4fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/620/1240" alt="创建仓库"></p>
<p>举例：</p>
<blockquote>
<ul>
<li>Name : me</li>
<li>Type : Maven</li>
</ul>
</blockquote>
<h3 id="4、获取头像对应的API-KEY"><a href="#4、获取头像对应的API-KEY" class="headerlink" title="4、获取头像对应的API KEY"></a>4、获取头像对应的API KEY</h3><p>点击右上角个人头像进入到个人信息主界面，点击Edit按钮即可进入到下图所示的界面。点击“API KEY”，输入Bintray本账号的登陆密码，即可查看到本账号的API KEY<br><img src="http://upload-images.jianshu.io/upload_images/1814304-c7229a3e316c3b4e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240/h/620" alt="API KEY"></p>
<h3 id="5、Add-New-Package"><a href="#5、Add-New-Package" class="headerlink" title="5、Add New Package"></a>5、Add New Package</h3><p><img src="http://upload-images.jianshu.io/upload_images/1814304-3e4a1570454101d2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/620/h/1240" alt="创建包"><br>举例：</p>
<blockquote>
<ul>
<li>Name : imagelib</li>
<li>License : Apache-2.0</li>
<li>Version control : <a href="https://github.com/soulrelay/ImageLoaderUtil" target="_blank" rel="external">https://github.com/soulrelay/ImageLoaderUtil</a></li>
</ul>
</blockquote>
<h3 id="6、Project的build-gradle添加如下信息"><a href="#6、Project的build-gradle添加如下信息" class="headerlink" title="6、Project的build.gradle添加如下信息"></a>6、Project的build.gradle添加如下信息</h3><p>在Project的build.gradle添加如下信息:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//用于打包Maven所需文件</div><div class="line">classpath &apos;com.github.dcendents:android-maven-gradle-plugin:1.4.1&apos; </div><div class="line">//用于上传Maven生成的文件到Bintray</div><div class="line">classpath &apos;com.jfrog.bintray.gradle:gradle-bintray-plugin:1.6&apos;</div></pre></td></tr></table></figure></p>
<p>我的Project的build.gradle的完整信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">// Top-level build file where you can add configuration options common to all sub-projects/modules.</div><div class="line">buildscript &#123;</div><div class="line">repositories &#123;</div><div class="line">jcenter()</div><div class="line">&#125;</div><div class="line">dependencies &#123;</div><div class="line">classpath &apos;com.android.tools.build:gradle:2.3.0&apos;</div><div class="line"></div><div class="line">//用于打包Maven所需文件</div><div class="line">classpath &apos;com.github.dcendents:android-maven-gradle-plugin:1.4.1&apos; </div><div class="line">//用于上传Maven生成的文件到Bintray</div><div class="line">classpath &apos;com.jfrog.bintray.gradle:gradle-bintray-plugin:1.6&apos; </div><div class="line"></div><div class="line">// NOTE: Do not place your application dependencies here; they belong</div><div class="line">// in the individual module build.gradle files</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">allprojects &#123;</div><div class="line">repositories &#123;</div><div class="line">jcenter()</div><div class="line">maven &#123;</div><div class="line">name &apos;glide-snapshot&apos;</div><div class="line">url &apos;http://oss.sonatype.org/content/repositories/snapshots&apos;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">tasks.withType(Javadoc) &#123;</div><div class="line">options.addStringOption(&apos;Xdoclint:none&apos;, &apos;-quiet&apos;)</div><div class="line">options.addStringOption(&apos;encoding&apos;, &apos;UTF-8&apos;)</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">task clean(type: Delete) &#123;</div><div class="line">delete rootProject.buildDir</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="7、配置并应用bintrayUpload-gradle，配置bintray-properties和project-properties"><a href="#7、配置并应用bintrayUpload-gradle，配置bintray-properties和project-properties" class="headerlink" title="7、配置并应用bintrayUpload.gradle，配置bintray.properties和project.properties"></a>7、配置并应用bintrayUpload.gradle，配置bintray.properties和project.properties</h3><p><img src="http://upload-images.jianshu.io/upload_images/1814304-5e7a1d909f9dcbe2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/620/h/1240" alt="project目录结构"></p>
<h4 id="7-1-在imagelib-Module的根目录下创建bintrayUpload-gradle文件"><a href="#7-1-在imagelib-Module的根目录下创建bintrayUpload-gradle文件" class="headerlink" title="7.1 在imagelib Module的根目录下创建bintrayUpload.gradle文件"></a>7.1 在imagelib Module的根目录下创建bintrayUpload.gradle文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line">apply plugin: &apos;com.github.dcendents.android-maven&apos;</div><div class="line">apply plugin: &apos;com.jfrog.bintray&apos;</div><div class="line"></div><div class="line">//加载属性文件</div><div class="line">Properties properties = new Properties()</div><div class="line">File localPropertiesFile = project.file(&quot;bintray.properties&quot;);</div><div class="line">if (localPropertiesFile.exists()) &#123;</div><div class="line">properties.load(localPropertiesFile.newDataInputStream())</div><div class="line">&#125;</div><div class="line">File projectPropertiesFile = project.file(&quot;project.properties&quot;);</div><div class="line">if (projectPropertiesFile.exists()) &#123;</div><div class="line">properties.load(projectPropertiesFile.newDataInputStream())</div><div class="line">&#125;</div><div class="line"></div><div class="line">//读取属性</div><div class="line">def projectRepositoryName = properties.getProperty(&quot;project.repositoryName&quot;)</div><div class="line">def projectName = properties.getProperty(&quot;project.name&quot;)</div><div class="line">def projectGroupId = properties.getProperty(&quot;project.groupId&quot;)</div><div class="line">def projectArtifactId = properties.getProperty(&quot;project.artifactId&quot;)</div><div class="line">def projectVersionName = android.defaultConfig.versionName</div><div class="line">def projectPackaging = properties.getProperty(&quot;project.packaging&quot;)</div><div class="line">def projectSiteUrl = properties.getProperty(&quot;project.siteUrl&quot;)</div><div class="line">def projectGitUrl = properties.getProperty(&quot;project.gitUrl&quot;)</div><div class="line">def projectVersionDesc = properties.getProperty(&quot;project.versiondesc&quot;)</div><div class="line">def projectVersionVcsTag = properties.getProperty(&quot;project.versionvcstag&quot;)</div><div class="line"></div><div class="line">def developerId = properties.getProperty(&quot;developer.id&quot;)</div><div class="line">def developerName = properties.getProperty(&quot;developer.name&quot;)</div><div class="line">def developerEmail = properties.getProperty(&quot;developer.email&quot;)</div><div class="line"></div><div class="line">def bintrayUser = properties.getProperty(&quot;bintray.user&quot;)</div><div class="line">def bintrayApikey = properties.getProperty(&quot;bintray.apiKey&quot;)</div><div class="line">def bintrayOrganizationId = properties.getProperty(&quot;bintray.organizationId&quot;);</div><div class="line"></div><div class="line">def javadocName = properties.getProperty(&quot;javadoc.name&quot;)</div><div class="line"></div><div class="line">group = projectGroupId</div><div class="line"></div><div class="line">// 配置生成POM.xml文件的参数</div><div class="line">install &#123;</div><div class="line">repositories.mavenInstaller &#123;</div><div class="line">pom &#123;</div><div class="line">project &#123;</div><div class="line">name projectName</div><div class="line">groupId projectGroupId</div><div class="line">artifactId projectArtifactId</div><div class="line">version projectVersionName</div><div class="line">packaging projectPackaging</div><div class="line">url projectSiteUrl</div><div class="line">licenses &#123;</div><div class="line">license &#123;</div><div class="line">name &apos;The Apache Software License, Version 2.0&apos;</div><div class="line">url &apos;http://www.apache.org/licenses/LICENSE-2.0.txt&apos;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">developers &#123;</div><div class="line">developer &#123;</div><div class="line">id developerId</div><div class="line">name developerName</div><div class="line">email developerEmail</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">scm &#123;</div><div class="line">connection projectGitUrl</div><div class="line">developerConnection projectGitUrl</div><div class="line">url projectSiteUrl</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//生成sources.jar</div><div class="line">task sourcesJar(type: Jar) &#123;</div><div class="line">from android.sourceSets.main.java.srcDirs</div><div class="line">classifier = &apos;sources&apos;</div><div class="line">&#125;</div><div class="line"></div><div class="line">task javadoc(type: Javadoc) &#123;</div><div class="line">source = android.sourceSets.main.java.srcDirs</div><div class="line">classpath += project.files(android.getBootClasspath().join(File.pathSeparator))</div><div class="line">&#125;</div><div class="line"></div><div class="line">//生成javadoc.jar</div><div class="line">task javadocJar(type: Jar, dependsOn: javadoc) &#123;</div><div class="line">classifier = &apos;javadoc&apos;</div><div class="line">from javadoc.destinationDir</div><div class="line">&#125;</div><div class="line"></div><div class="line">artifacts &#123;</div><div class="line">archives javadocJar</div><div class="line">archives sourcesJar</div><div class="line">&#125;</div><div class="line"></div><div class="line">//javadoc的配置</div><div class="line">javadoc &#123;</div><div class="line">options &#123;</div><div class="line">encoding &quot;UTF-8&quot;</div><div class="line">charSet &apos;UTF-8&apos;</div><div class="line">author true</div><div class="line">version projectVersionName</div><div class="line">links &quot;http://docs.oracle.com/javase/7/docs/api&quot;</div><div class="line">title javadocName</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">bintray &#123;</div><div class="line">user = bintrayUser</div><div class="line">key = bintrayApikey</div><div class="line">configurations = [&apos;archives&apos;]</div><div class="line">pkg &#123;</div><div class="line">//userOrg = bintrayOrganizationId</div><div class="line">repo = projectRepositoryName</div><div class="line">name = projectName</div><div class="line">websiteUrl = projectSiteUrl</div><div class="line">vcsUrl = projectGitUrl</div><div class="line">licenses = [&quot;Apache-2.0&quot;]</div><div class="line">publish = true</div><div class="line">version &#123;</div><div class="line">name = projectVersionName</div><div class="line">desc = projectVersionDesc</div><div class="line">vcsTag = projectVersionVcsTag</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="7-2-在imagelib-Module的build-gradle中应用上面创建的bintrayUpload-gradle文件，添加如下代码"><a href="#7-2-在imagelib-Module的build-gradle中应用上面创建的bintrayUpload-gradle文件，添加如下代码" class="headerlink" title="7.2 在imagelib Module的build.gradle中应用上面创建的bintrayUpload.gradle文件，添加如下代码"></a>7.2 在imagelib Module的build.gradle中应用上面创建的bintrayUpload.gradle文件，添加如下代码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apply from: &quot;bintrayUpload.gradle&quot;</div></pre></td></tr></table></figure>
<p>这里注意会遇到一个奇葩问题：</p>
<blockquote>
<ul>
<li>Where:<br>Script ‘/Users/sus/share/ImageLoaderUtil/imagelib/bintrayUpload.gradle’ line: 85<br>*What went wrong:<br>A problem occurred evaluating script.<br>android.compileSdkVersion is missing!</li>
</ul>
</blockquote>
<p>其实就是「 android.compileSdkVersion is missing!」 这个问题很奇葩，需要把<br>apply from: “bintrayUpload.gradle”这句话放在最下面，如下完整文件信息所示，我碰到这个问题的时候是直接把这句话放在apply plugin: ‘com.android.library’的后面了</p>
<p>完整文件信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">apply plugin: &apos;com.android.library&apos;</div><div class="line"></div><div class="line">android &#123;</div><div class="line">compileSdkVersion 24</div><div class="line">buildToolsVersion &apos;25.0.0&apos;</div><div class="line">defaultConfig &#123;</div><div class="line">minSdkVersion 15</div><div class="line">targetSdkVersion 25</div><div class="line">versionCode 1</div><div class="line">versionName &quot;1.0.0&quot;</div><div class="line">testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</div><div class="line">&#125;</div><div class="line">buildTypes &#123;</div><div class="line">release &#123;</div><div class="line">minifyEnabled false</div><div class="line">proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">compile fileTree(include: [&apos;*.jar&apos;], dir: &apos;libs&apos;)</div><div class="line">androidTestCompile(&apos;com.android.support.test.espresso:espresso-core:2.2.2&apos;, &#123;</div><div class="line">exclude group: &apos;com.android.support&apos;, module: &apos;support-annotations&apos;</div><div class="line">&#125;)</div><div class="line">compile &apos;com.android.support:appcompat-v7:24.2.1&apos;</div><div class="line">testCompile &apos;junit:junit:4.12&apos;</div><div class="line">compile &apos;com.android.support:support-v4:24.2.1&apos;</div><div class="line">compile &apos;com.squareup.okhttp3:okhttp:3.4.2&apos;</div><div class="line">compile &apos;com.github.bumptech.glide:glide:3.8.0-SNAPSHOT&apos;</div><div class="line">compile &apos;com.github.bumptech.glide:okhttp-integration:1.5.0-SNAPSHOT&apos;</div><div class="line">&#125;</div><div class="line"></div><div class="line">apply from: &quot;bintrayUpload.gradle&quot;</div></pre></td></tr></table></figure></p>
<h4 id="7-3-在imagelib-Module的根目录下创建7-1要读取的配置文件"><a href="#7-3-在imagelib-Module的根目录下创建7-1要读取的配置文件" class="headerlink" title="7.3 在imagelib Module的根目录下创建7.1要读取的配置文件"></a>7.3 在imagelib Module的根目录下创建7.1要读取的配置文件</h4><p>创建bintray.properties用于配置bintray和开发者信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">#配置bintray账号相关信息</div><div class="line">#bintray用户名,不是登陆邮箱,是个人中心右上角显示的名字</div><div class="line">bintray.user=su2008shuai</div><div class="line">#bintray的ApiKey</div><div class="line">bintray.apiKey=xxxxxxxxxxxxx</div><div class="line"></div><div class="line">#bintray的Organization Id</div><div class="line">#bintray.organizationId=soulrelay</div><div class="line"></div><div class="line"></div><div class="line">#配置开发者信息</div><div class="line">#昵称</div><div class="line">developer.id=sushuai</div><div class="line">#姓名</div><div class="line">developer.name=sushuai</div><div class="line">#邮箱</div><div class="line">developer.email=su2008shuai@gmail.com</div></pre></td></tr></table></figure></p>
<p>创建project.properties用于配置项目信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">#project</div><div class="line">#仓库名称，就是在bintray官网建立的仓库的名称</div><div class="line">project.repositoryName=me</div><div class="line">#项目名称</div><div class="line">project.name=imagelib</div><div class="line">#项目组id</div><div class="line">project.groupId=com.sus.library</div><div class="line">#项目id,一般同project.name</div><div class="line">project.artifactId=imagelib</div><div class="line">#打包类型</div><div class="line">project.packaging=aar</div><div class="line">#项目官方网站地址</div><div class="line">project.siteUrl=https://github.com/soulrelay/ImageLoaderUtil</div><div class="line">#项目git地址</div><div class="line">project.gitUrl=https://github.com/soulrelay/ImageLoaderUtil</div><div class="line">#生成的javadoc名称</div><div class="line">javadoc.name=imagelib</div><div class="line"></div><div class="line">project.versiondesc = 1.0.0 normal</div><div class="line">project.versionvcstag = 1.0.0 tag</div></pre></td></tr></table></figure></p>
<h4 id="7-4-在Terminal窗口下输入如下指令上传到Bintray"><a href="#7-4-在Terminal窗口下输入如下指令上传到Bintray" class="headerlink" title="7.4 在Terminal窗口下输入如下指令上传到Bintray"></a>7.4 在Terminal窗口下输入如下指令上传到Bintray</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">gradlew install</div><div class="line">gradlew bintrayUpload</div></pre></td></tr></table></figure>
<p>期间可能会碰到如下问题</p>
<blockquote>
<ul>
<li>-bash: gradlew: command not found</li>
</ul>
</blockquote>
<p>解决方案：<br>gradlew is not in your global path. To execute the ‘clean’ task (or any task for that matter) using the gradle wrapper (gradlew) in your project directory in your terminal, specify the current directory with the ‘./‘:</p>
<blockquote>
<ul>
<li>./gradlew clean</li>
</ul>
</blockquote>
<p>Running mac, you also have to do “chmod 755 gradlew” on the file before to make it executable.</p>
<p>归结起来的话：</p>
<blockquote>
<ul>
<li>chmod 755 gradlew</li>
<li>./gradlew install</li>
<li>./gradlew bintrayUpload</li>
</ul>
</blockquote>
<p>若出现BUILD SUCCESSFUL则说明成功上传到了Bintray(有时候在执行./gradlew bintrayUpload的时候报错，但这时去bintray官网查看它也上传成功了，可能是缓存的问题，可以Invalidate Caches or clean restart一下试试)</p>
<h3 id="8、添加imagelib-Package到JCenter"><a href="#8、添加imagelib-Package到JCenter" class="headerlink" title="8、添加imagelib Package到JCenter"></a>8、添加imagelib Package到JCenter</h3><p>进入到Bintray网站，找到刚才上传的项目，点击右下角的“Add To JCenter”按钮<br>然后填写项目描述点击“Send”提交审核即可（这里可以什么都不干，直接点击Send按钮），如果审核成功，它会给你发送一封站内信（同时你注册的邮箱优也会收到通知，1天之内肯定可以收到通知）通知你。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1814304-f862140619fdecaa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="审核成功通知"></p>
<p>访问这个链接：<a href="https://jcenter.bintray.com/com/sus/library/imagelib/1.0.0/" target="_blank" rel="external">https://jcenter.bintray.com/com/sus/library/imagelib/1.0.0/</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1814304-7a9ef92c5c879d3a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="jcenter库链接"><br><img src="http://upload-images.jianshu.io/upload_images/1814304-da1865ced355d93c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="审核成功后的包结构"></p>
<p>###9、其它问题和说明</p>
<blockquote>
<ul>
<li><p>Could not upload to ‘<a href="https://api.bintray.com/content/su2008shuai/me/ImageLoaderUtil/1.0/ImageLoaderUtil/imagelib/1.0/imagelib-1.0-javadoc.jar" target="_blank" rel="external">https://api.bintray.com/content/su2008shuai/me/ImageLoaderUtil/1.0/ImageLoaderUtil/imagelib/1.0/imagelib-1.0-javadoc.jar</a>‘: HTTP/1.1 400 Bad Request [message:Failed to resolve package name]</p>
</li>
<li><p>Error:Could not find ImageLoaderUtil.jar (com.sus.library:ImageLoaderUtil:1.0.1).<br>Searched in the following locations:<br><a href="https://jcenter.bintray.com/com/sus/library/ImageLoaderUtil/1.0.1/ImageLoaderUtil-1.0.1.jar" target="_blank" rel="external">https://jcenter.bintray.com/com/sus/library/ImageLoaderUtil/1.0.1/ImageLoaderUtil-1.0.1.jar</a></p>
</li>
</ul>
</blockquote>
<p>类似上面的问题的原因都是配置不对，bintray.properties和project.properties上的配置一定要和bintray线上的配置一致，否则会报各种找不到xx的问题</p>
<blockquote>
<ul>
<li>我的CSDN博客地址：<a href="http://blog.csdn.net/s003603u" target="_blank" rel="external">http://blog.csdn.net/s003603u</a></li>
<li>我的GitHub地址：<a href="https://github.com/soulrelay" target="_blank" rel="external">https://github.com/soulrelay</a></li>
<li>我的简书地址：<a href="http://www.jianshu.com/u/514ca03bbc17" target="_blank" rel="external">http://www.jianshu.com/u/514ca03bbc17</a></li>
</ul>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/30/基于ToolBar等MD相关控件实现的沉浸式联动效果/" itemprop="url">
                  基于ToolBar等MD相关控件实现的沉浸式联动效果
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-30T13:50:00+08:00" content="2016-09-30">
              2016-09-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/30/基于ToolBar等MD相关控件实现的沉浸式联动效果/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/30/基于ToolBar等MD相关控件实现的沉浸式联动效果/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a><font color="#C4573C" size="5" face="黑体">前言</font></h2><center><br><img src="http://img.blog.csdn.net/20160930134134324" alt="Drawing" width="250px"><br></center>

<p>提前下班了！！！</p>
<h2 id="综述"><a href="#综述" class="headerlink" title="综述"></a><font color="#C4573C" size="5" face="黑体">综述</font></h2><p>先来看一下最终的效果图</p>
<p><center><br><img src="http://img.blog.csdn.net/20160930112259772" alt="这里写图片描述"><br></center></p>
<h3 id="功能点"><a href="#功能点" class="headerlink" title="功能点"></a><font color="#C4573C" size="4" face="黑体">功能点</font></h3><font color="#d91717" size="3" face="黑体">1、CoordinatorLayout、AppBarLayout、CollapsingToolbarLayout、Toolbar、TabLayout、ViewPager联动使用</font>

<font color="#d91717" size="3" face="黑体">2、联动过程中保持沉浸式状态栏效果</font>

<font color="#d91717" size="3" face="黑体">3、ToolBar的基本使用，如自定义居中的title， Toolbar和Menu的结合使用，自定义溢出菜单样式</font><br>期间会涉及控件各种属性的设置，这个比较细碎<br><br>中间遇到一个问题，就是给menu，navigation等设置图片时，图片被拉伸（原因：把基于1280*720的切图放在了drawable文件夹下了，应该放在drawable-xhdpi）<br><br><font color="#d91717" size="3" face="黑体">4、解决应用启动白屏的问题</font>

<h2 id="各个突破"><a href="#各个突破" class="headerlink" title="各个突破"></a><font color="#C4573C" size="5" face="黑体">各个突破</font></h2><h3 id="设置ToolBar"><a href="#设置ToolBar" class="headerlink" title="设置ToolBar"></a><font color="#C4573C" size="4" face="黑体">设置ToolBar</font></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">private void setupToolbar() &#123;</div><div class="line">      toolbar = (Toolbar) findViewById(R.id.toolbar);</div><div class="line"></div><div class="line">      if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</div><div class="line">          int statusBarHeight = getStatusBarHeight(this);</div><div class="line">          FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams) toolbar.getLayoutParams();</div><div class="line">          layoutParams.topMargin = statusBarHeight;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      appbar = (AppBarLayout) findViewById(R.id.appbar);</div><div class="line"></div><div class="line">      setSupportActionBar(toolbar);</div><div class="line">      getSupportActionBar().setDisplayHomeAsUpEnabled(true); //使用系统自带的返回按钮</div><div class="line">      getSupportActionBar().setHomeAsUpIndicator(R.drawable.icon_back_normal);//替换系统自带的返回图标</div><div class="line"></div><div class="line">      toolbar.setOnMenuItemClickListener(onMenuItemClick);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private Toolbar.OnMenuItemClickListener onMenuItemClick = new Toolbar.OnMenuItemClickListener() &#123;</div><div class="line">      @Override</div><div class="line">      public boolean onMenuItemClick(MenuItem menuItem) &#123;</div><div class="line">          switch (menuItem.getItemId()) &#123;</div><div class="line">              case R.id.action_share:</div><div class="line">                  Toast.makeText(MainActivity.this, &quot;收藏&quot;, Toast.LENGTH_SHORT).show();</div><div class="line">                  //其余的省略</div><div class="line">                  break;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          return true;</div><div class="line">      &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  private void setupCollapsingToolbar() &#123;</div><div class="line">      collapseToolbar = (CollapsingToolbarLayout) findViewById(</div><div class="line">              R.id.collapse_toolbar);</div><div class="line"></div><div class="line">      collapseToolbar.setTitleEnabled(false);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h3 id="OnOffsetChangedListener联动显示"><a href="#OnOffsetChangedListener联动显示" class="headerlink" title="OnOffsetChangedListener联动显示"></a><font color="#C4573C" size="4" face="黑体">OnOffsetChangedListener联动显示</font></h3><p>实现AppBarLayout的OnOffsetChangedListener</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">   @Override</div><div class="line">    protected void onResume() &#123;</div><div class="line">        super.onResume();</div><div class="line">        appbar.addOnOffsetChangedListener(this);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void onPause() &#123;</div><div class="line">        super.onPause();</div><div class="line">        appbar.removeOnOffsetChangedListener(this);</div><div class="line">    &#125;</div><div class="line">@Override</div><div class="line">    public void onOffsetChanged(AppBarLayout appBarLayout, int verticalOffset) &#123;</div><div class="line">        if (lastPosition == verticalOffset) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        lastPosition = verticalOffset;</div><div class="line">        if (verticalOffset == 0) &#123;</div><div class="line">            getSupportActionBar().setTitle(&quot;&quot;);</div><div class="line">            btnRight.setVisibility(View.GONE);</div><div class="line">            viewTitle.setPadding(0, 6, 0, 0);</div><div class="line">            toolbarTitle.setText(&quot;&quot;);</div><div class="line">            return;</div><div class="line">        &#125; else if (verticalOffset &lt; -dip2px(this, 110)) &#123;</div><div class="line">            viewTitle.setPadding(0, 0, 0, 0);</div><div class="line">            getSupportActionBar().setTitle(&quot;&quot;);</div><div class="line">            btnRight.setVisibility(View.GONE);</div><div class="line">            toolbarTitle.setText(&quot;&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            viewTitle.setPadding(0, 6, 0, 0);</div><div class="line">            getSupportActionBar().setTitle(&quot;&quot;);</div><div class="line">            toolbarTitle.setText(&quot;军团再临&quot;);</div><div class="line">            btnRight.setVisibility(View.VISIBLE);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="自定义溢出菜单样式"><a href="#自定义溢出菜单样式" class="headerlink" title="自定义溢出菜单样式"></a><font color="#C4573C" size="4" face="黑体">自定义溢出菜单样式</font></h3><p>定义样式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;!--溢出菜单样式 --&gt;</div><div class="line">  &lt;style name=&quot;OverflowMenuStyle&quot; parent=&quot;@style/Widget.AppCompat.Light.PopupMenu.Overflow&quot;&gt;</div><div class="line">      &lt;item name=&quot;overlapAnchor&quot;&gt;false&lt;/item&gt;</div><div class="line">      &lt;item name=&quot;android:dropDownWidth&quot;&gt;wrap_content&lt;/item&gt;</div><div class="line">      &lt;item name=&quot;android:paddingRight&quot;&gt;5dp&lt;/item&gt;</div><div class="line">      &lt;item name=&quot;android:popupBackground&quot;&gt;@color/dcdcdc&lt;/item&gt;</div><div class="line">      &lt;item name=&quot;android:dropDownVerticalOffset&quot;&gt;4dip&lt;/item&gt;</div><div class="line">      &lt;item name=&quot;android:dropDownHorizontalOffset&quot;&gt;-4dip&lt;/item&gt;</div><div class="line">  &lt;/style&gt;</div></pre></td></tr></table></figure>
<p>添加到application theme中（前两个属性是为了解决启动白屏的问题）</p>
<p><a href="http://www.cnblogs.com/netcorner/p/4883069.html" target="_blank" rel="external">Android 启动白屏或者黑屏闪现解决</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;style name=&quot;Theme.AppStartLoadTranslucent&quot; parent=&quot;AppTheme&quot;&gt;</div><div class="line">      &lt;item name=&quot;android:windowIsTranslucent&quot;&gt;true&lt;/item&gt;</div><div class="line">      &lt;item name=&quot;android:windowNoTitle&quot;&gt;true&lt;/item&gt;</div><div class="line">      &lt;!--&lt;item name=&quot;actionOverflowMenuStyle&quot;&gt;@style/OverflowMenuStyle&lt;/item&gt;--&gt;</div><div class="line">  &lt;/style&gt;</div></pre></td></tr></table></figure></p>
<p>AndroidManifest.xml<br>设置theme为Theme.AppStartLoadTranslucent<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    package=&quot;com.soulrelay.coordinatorlayoutdemo&quot;&gt;</div><div class="line"></div><div class="line">    &lt;!-- To access Google+ APIs: --&gt;</div><div class="line">    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;application</div><div class="line">        android:allowBackup=&quot;true&quot;</div><div class="line">        android:icon=&quot;@mipmap/ic_launcher&quot;</div><div class="line">        android:label=&quot;@string/app_name&quot;</div><div class="line">        android:supportsRtl=&quot;true&quot;</div><div class="line">        android:theme=&quot;@style/Theme.AppStartLoadTranslucent&quot;&gt;</div><div class="line">        &lt;activity android:name=&quot;.MainActivity&quot;&gt;</div><div class="line">            &lt;intent-filter&gt;</div><div class="line">                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</div><div class="line"></div><div class="line">                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;</div><div class="line">            &lt;/intent-filter&gt;</div><div class="line">        &lt;/activity&gt;</div><div class="line">    &lt;/application&gt;</div><div class="line"></div><div class="line">&lt;/manifest&gt;</div></pre></td></tr></table></figure></p>
<p>其实，之前实现类似菜单功能采用popupwindow居多</p>
<h3 id="Toolbar中Menu中图标不显示的问题"><a href="#Toolbar中Menu中图标不显示的问题" class="headerlink" title="Toolbar中Menu中图标不显示的问题"></a><font color="#C4573C" size="4" face="黑体">Toolbar中Menu中图标不显示的问题</font></h3><p>在menu中，图标不会显示。<br>有的人是采用 onMenuOpened() 来写，可是仍然会有问题，对于AppCompactActivity你可以把onPrepareOptionsPanel（View v，Menu menu）代替 onMenuOpened() 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">    protected boolean onPrepareOptionsPanel(View view, Menu menu) &#123;</div><div class="line">        if (menu != null) &#123;</div><div class="line">            if (menu.getClass() == MenuBuilder.class) &#123;</div><div class="line">                try &#123;</div><div class="line">                    Method m = menu.getClass().getDeclaredMethod(&quot;setOptionalIconsVisible&quot;, Boolean.TYPE);</div><div class="line">                    m.setAccessible(true);</div><div class="line">                    m.invoke(menu, true);</div><div class="line">                &#125; catch (Exception e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return super.onPrepareOptionsPanel(view, menu);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="toolbar-menu中app-showAsAction各个属性值作用"><a href="#toolbar-menu中app-showAsAction各个属性值作用" class="headerlink" title=" toolbar menu中app:showAsAction各个属性值作用"></a><font color="#C4573C" size="4" face="黑体"> toolbar menu中app:showAsAction各个属性值作用</font></h3><p>android:showAsAction。这个属性可接受的值有： </p>
<blockquote>
<ul>
<li>always：使菜单项一直显示在ToolBar上。 </li>
<li>ifRoom：如果有足够的空间，这个值会使菜单项显示在ToolBar上。 </li>
<li>never：使菜单项永远都不出现在ToolBar上,在…的子项中显示。 </li>
<li>withText：使菜单项和它的图标，菜单文本一起显示。<h2 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a><font color="#C4573C" size="5" face="黑体">源码下载</font></h2><a href="http://download.csdn.net/detail/s003603u/9643815" target="_blank" rel="external">联盟-暗影之月-传送门</a><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a><font color="#C4573C" size="5" face="黑体">参考链接</font></h2><a href="http://blog.csdn.net/zhangphil/article/details/48680055" target="_blank" rel="external">Android布局属性android:clipToPadding的UI设计妙用</a><br><a href="http://www.jianshu.com/p/79604c3ddcae" target="_blank" rel="external">Android开发：最详细的 Toolbar 开发实践总结</a><br><a href="http://www.daxueit.com/article/9354.html" target="_blank" rel="external">fitsSystemWindows</a></li>
</ul>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/26/列表全家桶之刷新、加载更多、悬浮、左滑删除/" itemprop="url">
                  列表全家桶之刷新、加载更多、悬浮、左滑删除
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-26T10:44:00+08:00" content="2016-09-26">
              2016-09-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/26/列表全家桶之刷新、加载更多、悬浮、左滑删除/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/26/列表全家桶之刷新、加载更多、悬浮、左滑删除/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a><font color="#C4573C" size="5" face="黑体">需求</font></h2><h3 id="直播入口"><a href="#直播入口" class="headerlink" title="直播入口"></a><font color="#C4573C" size="4" face="黑体">直播入口</font></h3><p><img src="http://img.blog.csdn.net/20160924143742239" alt="这里写图片描述"></p>
<h3 id="功能点"><a href="#功能点" class="headerlink" title="功能点"></a><font color="#C4573C" size="4" face="黑体">功能点</font></h3><blockquote>
<ul>
<li>下拉刷新历史数据（这里自定义了refresh header，颠球，射门一气呵成~~）</li>
<li>上拉加载更多比赛</li>
<li>时间头悬浮</li>
<li>两个“今天”的定位锚点</li>
<li>内部相关的业务模型采用MVP构建<br>算是对<a href="http://blog.csdn.net/s003603u/article/details/51393218%20%E2%80%9CAndroid-architecture%E4%B9%8BMVC%E3%80%81MVP%E3%80%81MVVM%E3%80%81Data-Binding%E2%80%9D" target="_blank" rel="external">Android-architecture之MVC、MVP、MVVM、Data-Binding</a>中的MVP进一步的升级，抽取出了BasePresenter、BaseView、MVPBaseActivity、MVPBaseFragment，并通过使用弱引用预防可能发生的内存泄露问题<br>这里就不做赘述，后续有时间会整理一下（基于MVP模型构建多接口，多嵌套复杂数据类型，多视图的的多交互模型）</li>
</ul>
</blockquote>
<h3 id="我的预约"><a href="#我的预约" class="headerlink" title="我的预约"></a><font color="#C4573C" size="4" face="黑体">我的预约</font></h3><p><img src="http://img.blog.csdn.net/20160923114144939" alt="这里写图片描述"></p>
<h3 id="功能点-1"><a href="#功能点-1" class="headerlink" title="功能点"></a><font color="#C4573C" size="4" face="黑体">功能点</font></h3><blockquote>
<ul>
<li>相对于直播入口少了些相关交互功能</li>
<li>增加了左滑删除取消预约的功能</li>
<li>还有一个隐藏功能，就是多页面的比赛预约同步处理，这里采用<a href="http://blog.csdn.net/s003603u/article/details/51852019" target="_blank" rel="external">EventBus</a>事件总线库进行组件间的通信，然后根据通知做相应的业务处理<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a><font color="#C4573C" size="5" face="黑体">实战</font></h2><h3 id="控件原型搭建"><a href="#控件原型搭建" class="headerlink" title="控件原型搭建"></a><font color="#C4573C" size="4" face="黑体">控件原型搭建</font></h3>秉着不重复造轮子的宗旨，使用了如下著名的开源控件</li>
<li>悬浮头置顶功能<br>  StickyListHeaders<br>  An android library for section headers that stick to the top<br>  <a href="https://github.com/emilsjolander/StickyListHeaders" target="_blank" rel="external">https://github.com/emilsjolander/StickyListHeaders</a></li>
<li>下拉刷新 上拉加载更多<br> SwipeToLoadLayout<br> A reusable pull-to-refresh and pull-to-loadmore widget<br> <a href="https://github.com/Aspsine/SwipeToLoadLayout" target="_blank" rel="external">https://github.com/Aspsine/SwipeToLoadLayout</a></li>
<li>左滑删除见代码中的SwipeLayout，暂时找不到来源了</li>
</ul>
</blockquote>
<h3 id="最终的效果图"><a href="#最终的效果图" class="headerlink" title="最终的效果图"></a><font color="#C4573C" size="4" face="黑体">最终的效果图</font></h3><p>这个是在StickyListHeaders的基础上，整合了SwipeToLoadLayout和SwipeLayout</p>
<p>注意：  基于项目需求对部分开源控件做了相应的调整 </p>
<p><img src="http://img.blog.csdn.net/20160923115023333" alt="这里写图片描述"></p>
<h2 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a><font color="#C4573C" size="5" face="黑体">源码下载</font></h2><p><a href="http://download.csdn.net/detail/s003603u/9638917" target="_blank" rel="external">军团再临传送门</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/29/Android View的事件分发机制/" itemprop="url">
                  Android View的事件分发机制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-29T16:46:00+08:00" content="2016-07-29">
              2016-07-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/29/Android View的事件分发机制/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/29/Android View的事件分发机制/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a><font color="#C4573C" size="5" face="黑体">前言</font></h2><p>关于Android View事件分发机制的一个小结，基于他人分析以及个人理解，方便自己记录以及回忆，使用了一些UML图和流程图对部分流程进行了细化，并加入了自己的理解，期间参考了几篇比较优秀（不同博文可能针对的Android代码版本不同，存在些许出入，但是大致逻辑一致）的关于事件分发机制的博文，已在参考链接中列出。</p>
<p>该篇博文更适合那些对事件分发机制基本了解但是仍然缺少一个系统化轮廓的朋友，只是一个总结而非教程，如果完全没有概念的话先从参考链接的博文开始看起！然后再回过头来看这个总结。</p>
<p>如果发现有什么问题，欢迎留言拍砖！</p>
<h2 id="Activity的事件分发逻辑"><a href="#Activity的事件分发逻辑" class="headerlink" title="Activity的事件分发逻辑"></a><font color="#C4573C" size="5" face="黑体">Activity的事件分发逻辑</font></h2><p><img src="http://img.blog.csdn.net/20160729153418582" alt="这里写图片描述"></p>
<blockquote>
<ul>
<li>点击事件最先传递给当前的Activity，由Activity的dispatchToucnEvent来进行事件分发，具体的工作由Activity内部的Window来完成，Window会将事件传递给DecorView，DecorView一般就是当前界面的底层容器（即setContentView所设置的View的父容器），通过Activity.getWindow.getDecorView()可以获得</li>
<li>如果所有的View的onTouchEvent都返回了false，那么Activity的onTouchEvent就会被调用</li>
<li>Window的唯一实现是PhoneWindow</li>
<li>PhoneWindow中通过DecorView往下分发事件</li>
<li>通过((ViewGroup))getWindow().getDecorView().findViewById(android.R.id.content).getChildAt(0)可以获得Activity所设置的View</li>
<li>DecorView继承自FrameLayout且是父View，所以最终事件会传递给View</li>
</ul>
</blockquote>
<p><img src="http://img.blog.csdn.net/20160729153432350" alt="这里写图片描述"></p>
<h2 id="ViewGroup以及View的事件分发逻辑"><a href="#ViewGroup以及View的事件分发逻辑" class="headerlink" title="ViewGroup以及View的事件分发逻辑"></a><font color="#C4573C" size="5" face="黑体">ViewGroup以及View的事件分发逻辑</font></h2><p><img src="http://img.blog.csdn.net/20160729153447488" alt="这里写图片描述"></p>
<blockquote>
<ul>
<li>ViewGroup中的onInterceptTouchEvent用来控制ViewGroup是否拦截事件向下传递</li>
<li>ViewGroup的主要的任务是找一个Target，并且用这个target传递事件</li>
<li>在Down并且不拦截的时候会多出一个寻找Target的过程，在这个过程中遍历子View，如果子View的dispatchTouch为true（如果这里返回false的话，那么接下来的action就不会继续传递，因为这时的target就为空，target为空的话，就会触发ViewGroup作为一个View的dispatchTouchEvent()方法），则这个子View就是当前ViewGroup的Target。找Target是处理Down事件时候特有的，其他事件不会触发找Target。</li>
<li>那么上面说的View的dispatchTouchEvent一定会返回true吗？默认情况下只要View是Clickable或者LongClickable，就一定消费事件，即返回true</li>
<li>找到Target之后如果再次调用ViewGroup的dispatchTouchEvent，就用经过一系列逻辑判断继续调用Target的dispatchTouchEvent</li>
<li>View的onTouchEvent中，当action == MotionEvent.ACTION_UP时，就会触发View的performClick()，所以onClick会晚于onTouch<br><img src="http://img.blog.csdn.net/20160729153503538" alt="这里写图片描述"></li>
</ul>
</blockquote>
<h2 id="总结和参考"><a href="#总结和参考" class="headerlink" title="总结和参考"></a><font color="#C4573C" size="5" face="黑体">总结和参考</font></h2><p>有没有发现，Android View的事件分发就是一个活生生的基于责任链模式实现的经典案例！</p>
<p>建议：可以根据自己不同的理解程度参考如下博文：<br><a href="http://www.nowamagic.net/academy/detail/50160216" target="_blank" rel="external">http://www.nowamagic.net/academy/detail/50160216</a><br><a href="http://blog.csdn.net/duo2005duo/article/details/51604119" target="_blank" rel="external">http://blog.csdn.net/duo2005duo/article/details/51604119</a><br><a href="http://blog.csdn.net/guolin_blog/article/details/9153747" target="_blank" rel="external">http://blog.csdn.net/guolin_blog/article/details/9153747</a><br>《Android开发艺术探索》</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/07/EventBus 更少的代码 更好的体验/" itemprop="url">
                  EventBus 更少的代码 更好的体验
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-07T18:49:00+08:00" content="2016-07-07">
              2016-07-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/07/EventBus 更少的代码 更好的体验/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/07/EventBus 更少的代码 更好的体验/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#C4573C" size="5" face="黑体">简介</font></h2><p>事件总线库，极大地简化了 Activities, Fragments, Threads, Services等各组件之间的通信。更少的代码，更好的体检<br><img src="http://img.blog.csdn.net/20160707183142111" alt="这里写图片描述"><br>EventBus的<a href="https://github.com/greenrobot/EventBus" target="_blank" rel="external">github地址</a></p>
<h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a><font color="#C4573C" size="5" face="黑体">优点</font></h2><blockquote>
<ul>
<li>简化组件之间的通信,对事件的发送者和接收者进行解耦;在Activity、Fragment、以及后台线程中运转良好;避免复杂和容易出错的依赖关系以及生命周期问题</li>
<li>使你的代码更简单，代码可读性更好</li>
<li>快</li>
<li>小（~ 50K的jar包）</li>
<li>在安装量多达100,000,000+ 的应用中实践，表现优异</li>
<li><p>独具特色的功能，如线程分发，优先级订阅等。<br><center><br><img src="http://img.blog.csdn.net/20160707180921690" alt="这里写图片描述"><br></center></p>
<h2 id="项目实战"><a href="#项目实战" class="headerlink" title="项目实战"></a><font color="#C4573C" size="5" face="黑体">项目实战</font></h2><p><center><br><img src="http://img.blog.csdn.net/20160707181044504" alt="这里写图片描述"><br></center></p>
<h3 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a><font color="#C4573C" size="4" face="黑体">需求背景</font></h3></li>
<li><p>登录、登出成功之后，涉及的相关页面要即时刷新登录数据，做出相应的调整</p>
</li>
<li>多个页面涉及比赛预约的状态，一个页面预约或者取消预约成功，要即时更新其它页面的比赛预约状态</li>
</ul>
</blockquote>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#C4573C" size="4" face="黑体">步骤</font></h3><p><strong>部分概念相关的可以参考下面的相关介绍穿插理解</strong></p>
<p><strong>1、首先需要定义消息类，该类可以不继承任何基类也不需要实现任何接口</strong></p>
<p>这里以LoginEvent（用户登录退出场景） 和AppointmentStateEvent （见注释）为例来介绍<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnEventBusInterface</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnLoginListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(LoginEvent event)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnTopicRefreshListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(FollowTopicRefreshEvent event)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnAppointmentStateListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(AppointmentStateEvent event)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginEvent</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> hasLoginSucc;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LoginEvent</span><span class="params">(<span class="keyword">boolean</span> loginSucc)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.hasLoginSucc = loginSucc;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasLoginSucc</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> hasLoginSucc;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHasLoginSucc</span><span class="params">(<span class="keyword">boolean</span> hasLoginSucc)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.hasLoginSucc = hasLoginSucc;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//FollowFragment刷新事件</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FollowTopicRefreshEvent</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 在比赛详情页</span></div><div class="line"><span class="comment">     * 比赛未开始</span></div><div class="line"><span class="comment">     * 从首页直播tab进入或者从球队详情页的比赛tab进入</span></div><div class="line"><span class="comment">     * 在比赛未开始时，可以预约或者取消预约比赛，这个操作完成后再返回上面两个入口时，需要刷新预约状态</span></div><div class="line"><span class="comment">     * 这里传入了matchId作为参数,目前没有用到，因为现在比赛的预约与否是存在本地数据库的</span></div><div class="line"><span class="comment">     * 如果以后预约比赛的状态和用户绑定在服务器，那么可能就需要使用这个matchId了</span></div><div class="line"><span class="comment">     * &lt;p/&gt;</span></div><div class="line"><span class="comment">     * 需要3个有关注状态的地方  互相通知最新的关注状态</span></div><div class="line"><span class="comment">     * add By SuS</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AppointmentStateEvent</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> String matchId;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AppointmentStateEvent</span><span class="params">(String matchId)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.matchId = matchId;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getMatchId</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> matchId;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMatchId</span><span class="params">(String matchId)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.matchId = matchId;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><strong>2、在需要订阅事件的地方注册事件，在需要取消消息订阅的地方取消消息订阅</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseLoginActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> <span class="keyword">implements</span> <span class="title">OnEventBusInterface</span>.<span class="title">OnLoginListener</span></span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        EventBus.getDefault().register(<span class="keyword">this</span>);<span class="comment">//注册EventBus</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        EventBus.getDefault().unregister(<span class="keyword">this</span>);<span class="comment">//反注册EventBus</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLoginSuccess</span><span class="params">()</span></span>&#123;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLoginOut</span><span class="params">()</span></span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(OnEventBusInterface.LoginEvent event)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(event.hasLoginSucc())&#123;</div><div class="line">            onLoginSuccess();</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            onLoginOut();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseLoginFragment</span> <span class="keyword">extends</span> <span class="title">BaseFragment</span> <span class="keyword">implements</span> <span class="title">IHandlerMessage</span>,<span class="title">OnEventBusInterface</span>.<span class="title">OnLoginListener</span>,<span class="title">OnEventBusInterface</span>.<span class="title">OnTopicRefreshListener</span>,<span class="title">OnEventBusInterface</span>.<span class="title">OnAppointmentStateListener</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> Handler handler;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewCreated</span><span class="params">(View view, Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onViewCreated(view, savedInstanceState);</div><div class="line">        handler = <span class="keyword">new</span> CommonHandler&lt;BaseLoginFragment&gt;(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        EventBus.getDefault().register(<span class="keyword">this</span>);<span class="comment">//注册EventBus</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        EventBus.getDefault().unregister(<span class="keyword">this</span>);<span class="comment">//反注册EventBus</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerCallback</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">showLoginWindow</span><span class="params">()</span></span>&#123;</div><div class="line">        StormUtils2.startLoginActivity(getActivity());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLoginSuccess</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLoginOut</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onFollowStatusChanged</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onAppointmentStateChanged</span><span class="params">(String matchId)</span></span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(OnEventBusInterface.LoginEvent event)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(event.hasLoginSucc())&#123;</div><div class="line">            onLoginSuccess();</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            onLoginOut();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(OnEventBusInterface.FollowTopicRefreshEvent event)</span></span>&#123;</div><div class="line">        onFollowStatusChanged();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(OnEventBusInterface.AppointmentStateEvent event)</span> </span>&#123;</div><div class="line">        onAppointmentStateChanged(event.getMatchId());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>3、分发事件，即触发消息</strong></p>
<p><img src="http://img.blog.csdn.net/20160707160724357" alt="这里写图片描述"></p>
<p>这里对BaseActivity小做解释：当通过插件化的方式加载暴风体育的时候，启动登录，通过startActivityForResult的方式调用主版的登录（之所以调用主版的登录是因为主应用和以插件化方式加载的暴风体育第三方登录（QQ，微信）的签名不同），当登录成功获取用户信息后，分发用户登录成功的消息</p>
<p>代码很简洁，具体相关操作如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EventBus.getDefault().post(<span class="keyword">new</span> OnEventBusInterface.LoginEvent(<span class="keyword">true</span>));<span class="comment">//登录成功</span></div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EventBus.getDefault().post(<span class="keyword">new</span> OnEventBusInterface.LoginEvent(<span class="keyword">false</span>));<span class="comment">//登出成功</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EventBus.getDefault().post(<span class="keyword">new</span> OnEventBusInterface.AppointmentStateEvent(String.valueOf(matchInfo.getId())));<span class="comment">//比赛预约状态改变成功</span></div></pre></td></tr></table></figure>
<p><strong>4、消息处理</strong></p>
<p>这里使用了最普通的方式，没有使用EventBus的注解模式，而且考虑到收到消息后的处理都是在主线程中完成，所以采用了onEventMainThread方法。</p>
<p>继承了BaseLoginActivity的Activity的相关处理：<br><img src="http://img.blog.csdn.net/20160707160737444" alt="这里写图片描述"></p>
<p>继承了BaseLoginFragment的Fragment的相关处理：<br><img src="http://img.blog.csdn.net/20160707160752467" alt="这里写图片描述"></p>
<p><strong>注意</strong>：</p>
<blockquote>
<ul>
<li>在3.0之前，EventBus还没有使用注解方式。消息处理的方法也只能限定于onEvent、onEventMainThread、onEventBackgroundThread和onEventAsync，分别代表四种线程模型。而在3.0之后，消息处理的方法可以随便取名，但是需要添加一个注解@Subscribe，并且要指定线程模型（默认为PostThread）</li>
<li>事件处理函数的访问权限必须为public，否则会报异常</li>
</ul>
</blockquote>
<p><strong>相关代码如下：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(OnEventBusInterface.LoginEvent event)</span></span>&#123;</div><div class="line">     <span class="keyword">if</span>(event.hasLoginSucc())&#123;</div><div class="line">         onLoginSuccess();</div><div class="line">     &#125;<span class="keyword">else</span>&#123;</div><div class="line">         onLoginOut();</div><div class="line">     &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(OnEventBusInterface.FollowTopicRefreshEvent event)</span></span>&#123;</div><div class="line">     onFollowStatusChanged();</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(OnEventBusInterface.AppointmentStateEvent event)</span> </span>&#123;</div><div class="line">     onAppointmentStateChanged(event.getMatchId());</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<center><br><img src="http://img.blog.csdn.net/20160707182411945" alt="这里写图片描述"><br></center><br>## <font color="#C4573C" size="5" face="黑体">相关介绍</font><br><br>### <font color="#C4573C" size="4" face="黑体">线程模型</font><br><br>主要包括如下四种：<br><img src="http://img.blog.csdn.net/20160707165447744" alt="这里写图片描述"><br><br><strong>POSTING</strong>：<br>&gt; <em> 发布事件和接收事件在同一个线程<br>&gt; </em> 避免执行耗时操作，否则会阻塞事件的传递，有可能会引起ANR<br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.POSTING) <span class="comment">// ThreadMode is optional here</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageEvent event)</span> </span>&#123;</div><div class="line">    log(event.message);</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br><strong>MAIN</strong>：<br>&gt; <em> 无论事件从哪里发布，接收事件都在UI线程<br>&gt; </em> 可以用来更新UI，但是不能处理耗时操作<br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Called in Android UI's main thread</span></div><div class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.MAIN)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageEvent event)</span> </span>&#123;</div><div class="line">    textField.setText(event.message);</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br><strong>BACKGROUND</strong>:<br>&gt; <em> 发布事件来自主线程，接收事件则在新的线程中运行；发布事件来自子线 程，接收事件也在该子线程完成<br>&gt; </em> 禁止进行UI更新操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Called in the background thread</span></div><div class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.BACKGROUND)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageEvent event)</span></span>&#123;</div><div class="line">    saveToDisk(event.message);</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br><strong>ASYNC</strong>：<br>&gt; <em> 无论事件从哪里发布，接收事件都在新的子线程<br>&gt; </em> 禁止进行UI更新操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Called in a separate thread</span></div><div class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.ASYNC)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageEvent event)</span></span>&#123;</div><div class="line">    backend.send(event.message);</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>### <font color="#C4573C" size="4" face="黑体">订阅优先级以及事件取消</font><br><br>尽管大多数情况下eventbus是不需要设置订阅的优先级和事件取消，但是某些特殊的场景可能派上用场。例如，当应用程序在前台，存在一个事件可能会触发一些用户界面相关逻辑，但当应用不可见时应该有不同的反应<br><br><strong>优先级设置</strong>:<br>&gt; <em> 默认优先级是0，同样的线程分发模式，优先级更高的订阅者会先收到消息<br>&gt; </em> 不同线程模式的订阅者接收消息的顺序呢不受优先级影响<br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Subscribe</span>(priority = <span class="number">1</span>);</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(MessageEvent event)</span> </span>&#123;</div><div class="line">…</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br><strong>事件取消</strong>：<br>&gt; <em> 事件取消一般都是被高优先级的订阅者调用<br>&gt; </em> 严格限制在线程模式为POSTING的消息处理方法中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Called in the same thread (default)</span></div><div class="line"><span class="meta">@Subscribe</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(MessageEvent event)</span></span>&#123;</div><div class="line"><span class="comment">// Process the event</span></div><div class="line">…</div><div class="line"></div><div class="line">EventBus.getDefault().cancelEventDelivery(event) ;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>### <font color="#C4573C" size="4" face="黑体">粘性事件</font><br>EventBus还支持发送黏性事件，就是在发送事件之后再订阅该事件也能收到该事件，能够收到订阅之前发送的消息。但是它只能收到最新的一次消息。<br><br>这里不做过多介绍，详情请参考<a href="http://greenrobot.org/eventbus/documentation/configuration/sticky-events/" target="_blank" rel="external">Sticky Events</a><br><br>## <font color="#C4573C" size="5" face="黑体">总结</font><br><br>&gt;<em> 简单强大<br>&gt;</em> 实战验证<br>&gt;<em> 高性能<br>&gt;</em> 基于API的简洁注解<br>&gt;<em> 主线程和子线程均可进行消息发布和订阅<br>&gt;</em> 事件以及订阅者继承特点<br>&gt;* 零配置且可配<br><br>码字！排版！画图！终于写完了！<br><center><br><img src="http://img.blog.csdn.net/20160707180337042" alt="这里写图片描述"><br></center>


          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/27/Android自定义View之如期相遇的百分比进度条RatioProgress/" itemprop="url">
                  Android自定义View之如期相遇的百分比进度条RatioProgress
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-27T10:34:00+08:00" content="2016-05-27">
              2016-05-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/27/Android自定义View之如期相遇的百分比进度条RatioProgress/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/27/Android自定义View之如期相遇的百分比进度条RatioProgress/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a><font color="#C4573C" size="5" face="黑体">需求</font></h1><h2 id="简述："><a href="#简述：" class="headerlink" title="简述："></a><font color="#C4573C" size="4" face="黑体">简述：</font></h2><p>当进入比赛详情页面时，根据点赞数按比例分割整个屏幕宽度，这个过程以动态进度条的形式显示</p>
<h2 id="实际应用效果图："><a href="#实际应用效果图：" class="headerlink" title="实际应用效果图："></a><font color="#C4573C" size="4" face="黑体">实际应用效果图：</font></h2><p><img src="http://img.blog.csdn.net/20160526182500108" alt="这里写图片描述"></p>
<h2 id="Demo效果图："><a href="#Demo效果图：" class="headerlink" title="Demo效果图："></a><font color="#C4573C" size="4" face="黑体">Demo效果图：</font></h2><p><img src="http://img.blog.csdn.net/20160526182514271" alt="这里写图片描述"></p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a><font color="#C4573C" size="5" face="黑体">分析</font></h1><h2 id="自定义View的基本步骤："><a href="#自定义View的基本步骤：" class="headerlink" title="自定义View的基本步骤："></a><font color="#C4573C" size="4" face="黑体">自定义View的基本步骤：</font></h2><blockquote>
<ul>
<li>自定义View的属性</li>
<li>在View的构造方法中获得我们自定义的属性</li>
<li>重写onMesure（非必须，大部分情况下需要）</li>
<li>重写onDraw</li>
</ul>
</blockquote>
<h2 id="自定义View属性："><a href="#自定义View属性：" class="headerlink" title="自定义View属性："></a><font color="#C4573C" size="4" face="黑体">自定义View属性：</font></h2><p>在res/values/  下建立一个attrs.xml ，在里面定义我们的属性和声明我们的整个样式，format是指该属性的取值类型</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"RatioProgress"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"direction"</span> <span class="attr">format</span>=<span class="string">"string"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"progressColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这里，我根据需求定义了两个属性，分别为direction和progressColor</p>
<blockquote>
<ul>
<li>direction表示进度条的绘制方向，有两个值，分别为“left”和“right”</li>
</ul>
</blockquote>
<p>“left”表示从左到右进行显示,“right”表示从右向左进行显示</p>
<blockquote>
<ul>
<li>progressColor表示进度条的显示背景颜色</li>
</ul>
</blockquote>
<h2 id="RatioProgress分析："><a href="#RatioProgress分析：" class="headerlink" title="RatioProgress分析："></a><font color="#C4573C" size="4" face="黑体">RatioProgress分析：</font></h2><blockquote>
<ul>
<li>通过rectBgBounds 绘制背景矩形，进行占位，背景设置为透明的</li>
<li><p>通过rectProgressBounds来绘制进度条，背景颜色就是通过如下自定义属性进行设置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sus:progressColor="@color/CommonTextSelect"</div></pre></td></tr></table></figure>
</li>
<li><p>bgPaint和progressPaint分别为绘制背景和进度条的画笔</p>
</li>
</ul>
</blockquote>
<font color="#C4573C" size="3" face="黑体">关键步骤之重写onDraw方法</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onDraw(canvas);</div><div class="line">    canvas.drawRect(rectBgBounds, bgPaint);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (TextUtils.equals(direction, <span class="string">"left"</span>)) &#123;</div><div class="line">        rectProgressBounds = <span class="keyword">new</span> RectF(<span class="number">0</span>, <span class="number">0</span>, progress, layout_height);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TextUtils.equals(direction, <span class="string">"right"</span>)) &#123;</div><div class="line">        rectProgressBounds = <span class="keyword">new</span> RectF(getWidth() - progress, <span class="number">0</span>, getWidth(), layout_height);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        rectProgressBounds = <span class="keyword">new</span> RectF(<span class="number">0</span>, <span class="number">0</span>, progress, layout_height);</div><div class="line">    &#125;</div><div class="line">    canvas.drawRect(rectProgressBounds, progressPaint);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>&gt;<em> 这里根据direction属性来设置rectProgressBounds 的坐标位置<br><br>&gt;</em> 我在 setupBounds()中通过start方法开启一个线程<br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> Runnable r = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        running = <span class="keyword">true</span>;</div><div class="line">        Log.e(<span class="string">"thread"</span>, <span class="string">"progress="</span>+progress);</div><div class="line">        Log.e(<span class="string">"thread"</span>, <span class="string">"getWidth()="</span>+getWidth());</div><div class="line">        <span class="keyword">while</span> (progress &lt; getWidth()) &#123;</div><div class="line">            incrementProgress();</div><div class="line">            <span class="comment">//progress++;</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(sleepDelay);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        running = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">if</span> (!running) &#123;</div><div class="line">        progress = <span class="number">0</span>;</div><div class="line">        Thread s = <span class="keyword">new</span> Thread(r);</div><div class="line">        s.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>&gt;* 并通过incrementProgress方法递增progress，然后再通过handler发消息不断进行绘制<br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">  * Increment the progress by 1 (of 100)</span></div><div class="line"><span class="comment">  */</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incrementProgress</span><span class="params">()</span> </span>&#123;</div><div class="line">     isProgress = <span class="keyword">true</span>;</div><div class="line">     progress++;</div><div class="line">     <span class="comment">/*</span></div><div class="line"><span class="comment">      * if (progress &gt; 200) progress = 100;</span></div><div class="line"><span class="comment">      */</span></div><div class="line">     spinHandler.sendEmptyMessage(<span class="number">0</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure><br><br><font color="#C4573C" size="3" face="黑体">RatioProgress 完整代码：</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RatioProgress</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// Sizes (with defaults)</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> layout_height = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> layout_width = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Colors (with defaults)</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> bgColor = Color.TRANSPARENT;</div><div class="line"></div><div class="line">    <span class="comment">//private int progressColor = 0xFF339933;</span></div><div class="line"></div><div class="line">    <span class="comment">// Paints</span></div><div class="line">    <span class="keyword">private</span> Paint progressPaint = <span class="keyword">new</span> Paint();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Paint bgPaint = <span class="keyword">new</span> Paint();</div><div class="line"></div><div class="line">    <span class="comment">// Rectangles</span></div><div class="line">    <span class="keyword">private</span> RectF rectBgBounds = <span class="keyword">new</span> RectF();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> RectF rectProgressBounds = <span class="keyword">new</span> RectF();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> progress = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> isProgress;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String direction;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * progress的颜色</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> progressColor;</div><div class="line">    </div><div class="line">    <span class="keyword">boolean</span> running;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> sleepDelay;</div><div class="line">    </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSleepDelay</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sleepDelay;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSleepDelay</span><span class="params">(<span class="keyword">int</span> sleepDelay)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.sleepDelay = sleepDelay;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Handler spinHandler = <span class="keyword">new</span> Handler() &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * This is the code that will increment the progress variable and so</span></div><div class="line"><span class="comment">         * spin the wheel</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            invalidate();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RatioProgress</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> attrs</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RatioProgress</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> attrs</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> defStyleAttr</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RatioProgress</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">        </div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 获得我们所定义的自定义样式属性</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        TypedArray a = context.getTheme().obtainStyledAttributes(attrs, R.styleable.RatioProgress, defStyleAttr, <span class="number">0</span>);</div><div class="line">        <span class="keyword">int</span> n = a.getIndexCount();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">int</span> attr = a.getIndex(i);</div><div class="line">            <span class="keyword">switch</span> (attr)</div><div class="line">            &#123;</div><div class="line">            <span class="keyword">case</span> R.styleable.RatioProgress_direction:</div><div class="line">                direction = a.getString(attr);</div><div class="line">                Log.e(<span class="string">"direction-----------------"</span>, direction);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.styleable.RatioProgress_progressColor:</div><div class="line">                progressColor = a.getColor(attr, Color.TRANSPARENT);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        a.recycle();</div><div class="line">        </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSizeChanged</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> oldw, <span class="keyword">int</span> oldh)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onSizeChanged(w, h, oldw, oldh);</div><div class="line">        <span class="comment">// Share the dimensions</span></div><div class="line">        layout_width = w;</div><div class="line">        Log.i(<span class="string">"layout_width"</span>, layout_width + <span class="string">""</span>);</div><div class="line"></div><div class="line">        layout_height = h;</div><div class="line">        Log.i(<span class="string">"layout_height"</span>, layout_height + <span class="string">""</span>);</div><div class="line">        setupBounds();</div><div class="line">        setupPaints();</div><div class="line">        invalidate();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupPaints</span><span class="params">()</span> </span>&#123;</div><div class="line">        bgPaint.setColor(bgColor);</div><div class="line">        bgPaint.setAntiAlias(<span class="keyword">true</span>);</div><div class="line">        bgPaint.setStyle(Style.FILL);</div><div class="line"></div><div class="line">        progressPaint.setColor(progressColor);</div><div class="line">        progressPaint.setAntiAlias(<span class="keyword">true</span>);</div><div class="line">        progressPaint.setStyle(Style.FILL);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupBounds</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> width = getWidth(); <span class="comment">// this.getLayoutParams().width;</span></div><div class="line">        Log.i(<span class="string">"width"</span>, width + <span class="string">""</span>);</div><div class="line">        <span class="keyword">int</span> height = getHeight(); <span class="comment">// this.getLayoutParams().height;</span></div><div class="line">        Log.i(<span class="string">"height"</span>, height + <span class="string">""</span>);</div><div class="line">        rectBgBounds = <span class="keyword">new</span> RectF(<span class="number">0</span>, <span class="number">0</span>, width, height);</div><div class="line">        start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDraw(canvas);</div><div class="line"></div><div class="line">        canvas.drawRect(rectBgBounds, bgPaint);</div><div class="line"></div><div class="line">        Log.i(<span class="string">"progress"</span>, progress + <span class="string">""</span>);</div><div class="line">        <span class="keyword">if</span> (TextUtils.equals(direction, <span class="string">"left"</span>)) &#123;</div><div class="line">            rectProgressBounds = <span class="keyword">new</span> RectF(<span class="number">0</span>, <span class="number">0</span>, progress, layout_height);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TextUtils.equals(direction, <span class="string">"right"</span>)) &#123;</div><div class="line">            rectProgressBounds = <span class="keyword">new</span> RectF(getWidth() - progress, <span class="number">0</span>, getWidth(), layout_height);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            rectProgressBounds = <span class="keyword">new</span> RectF(<span class="number">0</span>, <span class="number">0</span>, progress, layout_height);</div><div class="line">        &#125;</div><div class="line">        canvas.drawRect(rectProgressBounds, progressPaint);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Increment the progress by 1 (of 100)</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incrementProgress</span><span class="params">()</span> </span>&#123;</div><div class="line">        isProgress = <span class="keyword">true</span>;</div><div class="line">        progress++;</div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">         * if (progress &gt; 200) progress = 100;</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        spinHandler.sendEmptyMessage(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Increment the progress by 1 (of 100)</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unIncrementProgress</span><span class="params">()</span> </span>&#123;</div><div class="line">        isProgress = <span class="keyword">true</span>;</div><div class="line">        progress--;</div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">         * if (progress &lt; 1) progress = 100;</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        spinHandler.sendEmptyMessage(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Set the progress to a specific value</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProgress</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line"></div><div class="line">        progress = i;</div><div class="line">        spinHandler.sendEmptyMessage(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">final</span> Runnable r = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            running = <span class="keyword">true</span>;</div><div class="line">            Log.e(<span class="string">"thread"</span>, <span class="string">"progress="</span>+progress);</div><div class="line">            Log.e(<span class="string">"thread"</span>, <span class="string">"getWidth()="</span>+getWidth());</div><div class="line">            <span class="keyword">while</span> (progress &lt; getWidth()) &#123;</div><div class="line">                incrementProgress();</div><div class="line">                <span class="comment">//progress++;</span></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(sleepDelay);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            running = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">if</span> (!running) &#123;</div><div class="line">            progress = <span class="number">0</span>;</div><div class="line">            Thread s = <span class="keyword">new</span> Thread(r);</div><div class="line">            s.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>## <font color="#C4573C" size="4" face="黑体">布局以及代码中的使用：</font><br>### <font color="#C4573C" size="4" face="黑体">布局文件</font>

<p>这里在LinearLayout 中定义了两个RatioProgress<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:sus</span>=<span class="string">"http://schemas.android.com/apk/res/com.soulrelay.ratioprogress"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span> &gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">com.soulrelay.ratioprogress.RatioProgress</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/left_ratio_progress"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"4dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"100dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">sus:direction</span>=<span class="string">"left"</span></span></div><div class="line"><span class="tag">        <span class="attr">sus:progressColor</span>=<span class="string">"@color/CommonTextSelect"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">com.soulrelay.ratioprogress.RatioProgress</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/right_ratio_progress"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"4dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_marginLeft</span>=<span class="string">"4dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"100dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">sus:direction</span>=<span class="string">"right"</span> </span></div><div class="line"><span class="tag">        <span class="attr">sus:progressColor</span>=<span class="string">"@color/CommonSelect"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="实际java代码中的控制"><a href="#实际java代码中的控制" class="headerlink" title="实际java代码中的控制"></a><font color="#C4573C" size="4" face="黑体">实际java代码中的控制</font></h3><p>这里主要是设置leftRatioProgress和rightRatioProgress的宽度，以及通过设置View中的线程休眠时间来控制进度条可以同时相遇<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    </div><div class="line">    RatioProgress leftRatioProgress;</div><div class="line">    RatioProgress rightRatioProgress;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        </div><div class="line">        WindowManager manager = ((WindowManager) <span class="keyword">this</span></div><div class="line">                .getSystemService(Context.WINDOW_SERVICE));</div><div class="line"></div><div class="line">        DisplayMetrics dm = <span class="keyword">new</span> DisplayMetrics();</div><div class="line">        manager.getDefaultDisplay().getMetrics(dm);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> w = dm.widthPixels;</div><div class="line"></div><div class="line">        leftRatioProgress = (RatioProgress) findViewById(R.id.left_ratio_progress);</div><div class="line">        LayoutParams lp = leftRatioProgress.getLayoutParams();</div><div class="line">        lp.width = w/<span class="number">3</span>;</div><div class="line">        leftRatioProgress.setLayoutParams(lp);</div><div class="line">        </div><div class="line">        rightRatioProgress = (RatioProgress) findViewById(R.id.right_ratio_progress);</div><div class="line">        LayoutParams lp1 = rightRatioProgress.getLayoutParams();</div><div class="line">        lp1.width = w*<span class="number">2</span>/<span class="number">3</span>;</div><div class="line">        rightRatioProgress.setLayoutParams(lp1);</div><div class="line">        </div><div class="line">        leftRatioProgress.setSleepDelay(<span class="number">6</span>);</div><div class="line">        rightRatioProgress.setSleepDelay(<span class="number">3</span>);</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>实际代码中我是根据用户的点赞数来分割屏幕宽度，设置View中的休眠时间</p>
<p>以下代码仅供参考：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">  * 进度条形式显示赞数的比例</span></div><div class="line"><span class="comment">  *</span></div><div class="line"><span class="comment">  * <span class="doctag">@param</span> matchInfo</span></div><div class="line"><span class="comment">  * <span class="doctag">@author</span> sushuai</span></div><div class="line"><span class="comment">  */</span></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initRatioProgress</span><span class="params">(MatchInfo matchInfo)</span> </span>&#123;</div><div class="line">     <span class="keyword">int</span> width = SystemUtil.getScreenDisplayMinWidth(context);</div><div class="line">     <span class="keyword">int</span> leftWeight = matchInfo.getTeam1().getLikes();</div><div class="line">     <span class="keyword">int</span> rightWeight = matchInfo.getTeam2().getLikes();</div><div class="line">     <span class="keyword">int</span> leftWidth = <span class="number">0</span>, rightWidth = <span class="number">0</span>;</div><div class="line">     <span class="keyword">if</span> (leftWeight == <span class="number">0</span> &amp;&amp; rightWeight == <span class="number">0</span>) &#123;</div><div class="line">         leftWidth = rightWidth = width / <span class="number">2</span>;</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (leftWeight == <span class="number">0</span>) &#123;</div><div class="line">         rightWidth = width;</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rightWeight == <span class="number">0</span>) &#123;</div><div class="line">         leftWidth = width;</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         leftWidth = width * leftWeight / (leftWeight + rightWeight);</div><div class="line">         rightWidth = width * rightWeight / (leftWeight + rightWeight);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (leftRatioProgress != <span class="keyword">null</span>) &#123;</div><div class="line">         LayoutParams lp = leftRatioProgress.getLayoutParams();</div><div class="line">         lp.width = leftWidth;</div><div class="line">         leftRatioProgress.setLayoutParams(lp);</div><div class="line">         <span class="keyword">if</span> (leftWidth &gt;= rightWidth) &#123;</div><div class="line">             leftRatioProgress.setSleepDelay(<span class="number">1</span>);</div><div class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (leftWidth != <span class="number">0</span>) &#123;</div><div class="line">             leftRatioProgress.setSleepDelay(rightWidth / leftWidth);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (rightRatioProgress != <span class="keyword">null</span>) &#123;</div><div class="line">         LayoutParams lp = rightRatioProgress.getLayoutParams();</div><div class="line">         lp.width = rightWidth;</div><div class="line">         rightRatioProgress.setLayoutParams(lp);</div><div class="line">         <span class="keyword">if</span> (leftWidth &gt;= rightWidth &amp;&amp; rightWidth != <span class="number">0</span>) &#123;</div><div class="line">             rightRatioProgress.setSleepDelay(leftWidth / rightWidth);</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             rightRatioProgress.setSleepDelay(<span class="number">1</span>);</div><div class="line"></div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a><font color="#C4573C" size="5" face="黑体">其它</font></h1><h2 id="Demo下载："><a href="#Demo下载：" class="headerlink" title="Demo下载："></a><font color="#C4573C" size="4" face="黑体">Demo下载：</font></h2><p><a href="http://download.csdn.net/detail/s003603u/9532387" target="_blank" rel="external">传送门</a></p>
<h2 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a><font color="#C4573C" size="4" face="黑体">参考链接：</font></h2><p><a href="http://blog.csdn.net/wangjinyu501/article/details/38298737" target="_blank" rel="external">1、http://blog.csdn.net/wangjinyu501/article/details/38298737</a><br><a href="http://blog.csdn.net/lmj623565791/article/details/24252901/" target="_blank" rel="external">1、http://blog.csdn.net/lmj623565791/article/details/24252901/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/27/Android-architecture之MVC、MVP、MVVM、Data-Binding/" itemprop="url">
                  Android-architecture之MVC、MVP、MVVM、Data-Binding
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-27T10:29:00+08:00" content="2016-05-27">
              2016-05-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/27/Android-architecture之MVC、MVP、MVVM、Data-Binding/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/27/Android-architecture之MVC、MVP、MVVM、Data-Binding/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h1 id="传送门"><a href="#传送门" class="headerlink" title="传送门"></a><font color="#C4573C" size="5" face="黑体">传送门</font></h1><p><a href="http://blog.csdn.net/s003603u/article/details/51485709" target="_blank" rel="external">Android Architecture（Is Activity God？）</a></p>
<h1 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a><font color="#C4573C" size="5" face="黑体">MVC</font></h1><h2 id="结构简介"><a href="#结构简介" class="headerlink" title="结构简介"></a><font color="#C4573C" size="4" face="黑体">结构简介</font></h2><p><img src="http://img.blog.csdn.net/20160516105225460" alt="这里写图片描述"><br><img src="http://img.blog.csdn.net/20160516155514982" alt="这里写图片描述"></p>
<h2 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a><font color="#C4573C" size="4" face="黑体">实例分析</font></h2><p><img src="http://img.blog.csdn.net/20160516161401197" alt="这里写图片描述"></p>
<font color="#C4573C" size="3" face="黑体">Controller控制器式</font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">ActionBarActivity</span> <span class="keyword">implements</span> <span class="title">OnWeatherListener</span>, <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> WeatherModel weatherModel;</div><div class="line">    <span class="keyword">private</span> Dialog loadingDialog;</div><div class="line">    <span class="keyword">private</span> EditText cityNOInput;</div><div class="line">    <span class="keyword">private</span> TextView city;</div><div class="line">    <span class="keyword">private</span> TextView cityNO;</div><div class="line">    <span class="keyword">private</span> TextView temp;</div><div class="line">    <span class="keyword">private</span> TextView wd;</div><div class="line">    <span class="keyword">private</span> TextView ws;</div><div class="line">    <span class="keyword">private</span> TextView sd;</div><div class="line">    <span class="keyword">private</span> TextView wse;</div><div class="line">    <span class="keyword">private</span> TextView time;</div><div class="line">    <span class="keyword">private</span> TextView njd;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        weatherModel = <span class="keyword">new</span> WeatherModelImpl();</div><div class="line">        initView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 初始化View</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        cityNOInput = findView(R.id.et_city_no);</div><div class="line">        city = findView(R.id.tv_city);</div><div class="line">        cityNO = findView(R.id.tv_city_no);</div><div class="line">        temp = findView(R.id.tv_temp);</div><div class="line">        wd = findView(R.id.tv_WD);</div><div class="line">        ws = findView(R.id.tv_WS);</div><div class="line">        sd = findView(R.id.tv_SD);</div><div class="line">        wse = findView(R.id.tv_WSE);</div><div class="line">        time = findView(R.id.tv_time);</div><div class="line">        njd = findView(R.id.tv_njd);</div><div class="line">        findView(R.id.btn_go).setOnClickListener(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        loadingDialog = <span class="keyword">new</span> ProgressDialog(<span class="keyword">this</span>);</div><div class="line">        loadingDialog.setTitle(加载天气中...);</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 显示结果</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> weather</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">displayResult</span><span class="params">(Weather weather)</span> </span>&#123;</div><div class="line">        WeatherInfo weatherInfo = weather.getWeatherinfo();</div><div class="line">        city.setText(weatherInfo.getCity());</div><div class="line">        cityNO.setText(weatherInfo.getCityid());</div><div class="line">        temp.setText(weatherInfo.getTemp());</div><div class="line">        wd.setText(weatherInfo.getWD());</div><div class="line">        ws.setText(weatherInfo.getWS());</div><div class="line">        sd.setText(weatherInfo.getSD());</div><div class="line">        wse.setText(weatherInfo.getWSE());</div><div class="line">        time.setText(weatherInfo.getTime());</div><div class="line">        njd.setText(weatherInfo.getNjd());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 隐藏进度对话框</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hideLoadingDialog</span><span class="params">()</span> </span>&#123;</div><div class="line">        loadingDialog.dismiss();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</div><div class="line">            <span class="keyword">case</span> R.id.btn_go:</div><div class="line">                loadingDialog.show();</div><div class="line">                weatherModel.getWeather(cityNOInput.getText().toString().trim(), <span class="keyword">this</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Weather weather)</span> </span>&#123;</div><div class="line">        hideLoadingDialog();</div><div class="line">        displayResult(weather);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">()</span> </span>&#123;</div><div class="line">        hideLoadingDialog();</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, 获取天气信息失败, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span>  T <span class="title">findView</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (T) findViewById(id);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<font color="#C4573C" size="3" face="黑体">Model模型</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WeatherModel</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getWeather</span><span class="params">(String cityNumber, OnWeatherListener listener)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherModelImpl</span> <span class="keyword">implements</span> <span class="title">WeatherModel</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getWeather</span><span class="params">(String cityNumber, <span class="keyword">final</span> OnWeatherListener listener)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">/*数据层操作*/</span></div><div class="line">        VolleyRequest.newInstance().newGsonRequest(http:<span class="comment">//www.weather.com.cn/data/sk/ + cityNumber + .html,</span></div><div class="line">                Weather.class, <span class="keyword">new</span> Response.Listener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Weather weather)</span> </span>&#123;</div><div class="line">                        <span class="keyword">if</span> (weather != <span class="keyword">null</span>) &#123;</div><div class="line">                            listener.onSuccess(weather);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            listener.onError();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;, <span class="keyword">new</span> Response.ErrorListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</div><div class="line">                        listener.onError();</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure><br><br>## <font color="#C4573C" size="4" face="黑体">总结</font><br>&gt;<em> 扩展性好、维护性、模块职责明确<br>&gt;</em> 耦合性低（解耦）、V和M非真正意义上的分离<br><br><font color="#C4573C" size="3" face="黑体">什么时候适合使用MVC设计模式？</font>

<p>当一个小的项目且无需频繁修改需求就不用MVC框架来设计了，那样反而觉得代码过度设计，代码臃肿。一般在大的项目中，且业务逻辑处理复杂，页面显示比较多，需要模块化设计的项目使用MVC就有足够的优势了。</p>
<h1 id="MVP"><a href="#MVP" class="headerlink" title="MVP"></a><font color="#C4573C" size="5" face="黑体">MVP</font></h1><h2 id="结构简介-1"><a href="#结构简介-1" class="headerlink" title="结构简介"></a><font color="#C4573C" size="4" face="黑体">结构简介</font></h2><p><img src="http://img.blog.csdn.net/20160513112553811" alt="Drawing" width="1000px" height="170px"><br><img src="http://img.blog.csdn.net/20160513164339063" alt="这里写图片描述"></p>
<h2 id="为什么使用MVP模式"><a href="#为什么使用MVP模式" class="headerlink" title="为什么使用MVP模式"></a><font color="#C4573C" size="4" face="黑体">为什么使用MVP模式</font></h2><p>在Android开发中，Activity并不是一个标准的MVC模式中的Controller，它的首要职责是加载应用的布局和初始化用户界面，并接受并处理来自用户的操作请求，进而作出响应。随着界面及其逻辑的复杂度不断提升，Activity类的职责不断增加，以致变得庞大臃肿。当我们将其中复杂的逻辑处理移至另外的一个类（Presneter）中时，Activity其实就是MVP模式中View，它负责UI元素的初始化，建立UI元素与Presenter的关联（Listener之类），同时自己也会处理一些简单的逻辑（复杂的逻辑交由Presenter处理）.</p>
<p>另外，回想一下你在开发Android应用时是如何对代码逻辑进行单元测试的？是否每次都要将应用部署到Android模拟器或真机上，然后通过模拟用户操作进行测试？然而由于Android平台的特性，每次部署都耗费了大量的时间，这直接导致开发效率的降低。而在MVP模式中，处理复杂逻辑的Presenter是通过interface与View(Activity)进行交互的，这说明了什么？说明我们可以通过自定义类实现这个interface来模拟Activity的行为对Presenter进行单元测试，省去了大量的部署及测试的时间。</p>
<h2 id="实例分析-1"><a href="#实例分析-1" class="headerlink" title="实例分析"></a><font color="#C4573C" size="4" face="黑体">实例分析</font></h2><font color="#C4573C" size="3" face="黑体">MVP模式</font>

<p>View与Model并不直接交互，而是使用Presenter作为View与Model之间的桥梁。其中Presenter中同时持有Viwe层以及Model层的Interface的引用，而View层持有Presenter层Interface的引用。当View层某个界面需要展示某些数据的时候，首先会调用Presenter层的某个接口，然后Presenter层会调用Model层请求数据，当Model层数据加载成功之后会调用Presenter层的回调方法通知Presenter层数据加载完毕，最后Presenter层再调用View层的接口将加载后的数据展示给用户。这就是MVP模式的整个核心过程。</p>
<font color="#C4573C" size="3" face="黑体">官方模式图</font>


<p><a href="https://github.com/googlesamples/android-architecture" target="_blank" rel="external">android-architecture官方传送门</a><br><img src="http://img.blog.csdn.net/20160513113256749" alt="这里写图片描述"><br><img src="http://img.blog.csdn.net/20160513113408353" alt=""></p>
<font color="#C4573C" size="3" face="黑体">案例</font>

<p>这里以<font color="#C4573C" size="3" face="黑体">暴风体育</font>中的<font color="#C4573C" size="3" face="黑体">话题列表</font>为例来进行介绍：</p>
<p><img src="http://img.blog.csdn.net/20160513121034417" alt="这里写图片描述"><br><img src="http://img.blog.csdn.net/20160516163914095" alt="这里写图片描述"></p>
<font color="#C4573C" size="3" face="黑体">TopicModel </font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TopicModel</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 加载话题列表首页数据</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> listener</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">loadTopicList</span><span class="params">(Context context, TopicModelImpl.OnLoadTopicListListener listener)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 从本地数据库中获取我关注的话题数据</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> listener</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">ArrayList&lt;TopicItem&gt; <span class="title">loadFollowTopic</span><span class="params">(Context context, TopicModelImpl.OnLoadTopicListListener listener)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 全部话题加载更多数据</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> listener</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">loadMoreAllTopic</span><span class="params">(Context context, Map&lt;String, String&gt; paramMap, TopicModelImpl.OnLoadTopicListListener listener)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 更新我关注的话题的最新帖子数和帖子最近的更新时间</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> threadItem</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> listener</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateThreadItem</span><span class="params">(<span class="keyword">final</span> Context context, ThreadItem threadItem, TopicModelImpl.OnLoadTopicListListener listener)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<font color="#C4573C" size="3" face="黑体">TopicPresenter </font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TopicPresenter</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 加载话题列表首页数据</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">loadTopicList</span><span class="params">(Context context)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 全部话题加载更多数据</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">loadMoreAllTopic</span><span class="params">(Context context, Map&lt;String, String&gt; paramMap)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">ArrayList&lt;TopicItem&gt; <span class="title">loadFollowTopic</span><span class="params">(Context context)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<font color="#C4573C" size="3" face="黑体">TopicView </font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TopicView</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showProgress</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addTopics</span><span class="params">(List&lt;TopicItem&gt; topicList)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addSwipeUpItem</span><span class="params">(SwipeUpItem item)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addLoadMoreTopics</span><span class="params">(List&lt;TopicItem&gt; topicList)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hideProgress</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showLoadFailMsg</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">//二次请求需要重新刷新界面</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">notifyAdapter</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<font color="#C4573C" size="3" face="黑体">TopicModelImpl</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * DES：</span></div><div class="line"><span class="comment"> * Created by sushuai on 2016/4/13.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicModelImpl</span> <span class="keyword">implements</span> <span class="title">TopicModel</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"TopicModelImpl"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 加载话题列表首页数据</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> listener</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadTopicList</span><span class="params">(<span class="keyword">final</span> Context context, <span class="keyword">final</span> OnLoadTopicListListener listener)</span> </span>&#123;</div><div class="line">        AsyncHttpRequest.doASynGetRequest(context, UrlContainer.HOME_TOPIC, <span class="keyword">null</span>, <span class="keyword">true</span>, <span class="keyword">new</span> AsyncHttpRequest.CallBack() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fail</span><span class="params">(String ret)</span> </span>&#123;</div><div class="line">                listener.onFailure(Net.ErrorNo.NO_DATA);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String data)</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    ArrayList&lt;TopicItem&gt; items = (ArrayList&lt;TopicItem&gt;) TopicListDataParseUtils.readJsonTopicLists(data, listener);</div><div class="line">                    <span class="comment">//items.addAll(0, loadFollowTopic(context, listener));</span></div><div class="line">                    <span class="keyword">if</span> (items != <span class="keyword">null</span>) &#123;</div><div class="line">                        listener.onSuccess(items);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (JSONException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                    listener.onFailure(Net.ErrorNo.ERROR_JSON);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 从本地数据库中获取我关注的话题数据</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> listener</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ArrayList&lt;TopicItem&gt; <span class="title">loadFollowTopic</span><span class="params">(Context context, <span class="keyword">final</span> OnLoadTopicListListener listener)</span> </span>&#123;</div><div class="line">        ArrayList&lt;TopicItem&gt; items = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        ArrayList&lt;ThreadItem&gt; ThreadItems = (ArrayList&lt;ThreadItem&gt;) FollowTopicDao.getInstance(context).getLatest3Topics();</div><div class="line">        <span class="keyword">if</span> (ThreadItems.size() &lt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> items;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ThreadItems.size(); i++) &#123;</div><div class="line">            ThreadItem threadItem = ThreadItems.get(i);</div><div class="line">            updateThreadItem(context, threadItem, listener);</div><div class="line">        &#125;</div><div class="line">        TopicItem meItem = <span class="keyword">new</span> TopicItem();</div><div class="line">        meItem.setType(TopicAdapter.TYPE_TOPIC_TITLE_ME);</div><div class="line">        items.add(meItem);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ThreadItems.size(); i++) &#123;</div><div class="line">            TopicItem topicItem = <span class="keyword">new</span> TopicItem();</div><div class="line">            topicItem.setType(TopicAdapter.TYPE_TOPIC_THREAD);</div><div class="line">            topicItem.setOther(ThreadItems.get(i));</div><div class="line">            items.add(topicItem);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> items;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 更新我关注的话题的最新帖子数和帖子最近的更新时间</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> threadItem</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> listener</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateThreadItem</span><span class="params">(<span class="keyword">final</span> Context context, <span class="keyword">final</span> ThreadItem threadItem, <span class="keyword">final</span> OnLoadTopicListListener listener)</span> </span>&#123;</div><div class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        map.put(Net.Field.id, String.valueOf(threadItem.getId()));</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> prePosts = threadItem.getCount();</div><div class="line">        AsyncHttpRequest.doASynGetRequest(context, UrlContainer.GET_TOPIC_POSTS, (HashMap&lt;String, String&gt;) map, <span class="keyword">true</span>, <span class="keyword">new</span> AsyncHttpRequest.CallBack() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fail</span><span class="params">(String ret)</span> </span>&#123;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String data)</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    JSONObject jo = <span class="keyword">new</span> JSONObject(data);</div><div class="line">                    <span class="keyword">int</span> errno = DataParseUtils.getJsonInt(jo, Net.Field.errno);</div><div class="line">                    <span class="keyword">if</span> (errno == Net.ErrorNo.SUCCESS) &#123;</div><div class="line">                        JSONObject jsonObj = DataParseUtils.getJsonObj(jo, Net.Field.data);</div><div class="line">                        <span class="keyword">int</span> count = DataParseUtils.getJsonInt(jsonObj, Net.Field.count);</div><div class="line">                        <span class="keyword">long</span> latest_update_tm = DataParseUtils.getJsonLong(jsonObj, Net.Field.latest_update_tm);</div><div class="line">                        threadItem.setUpdateCount(count - prePosts);</div><div class="line">                        threadItem.setCount(count);</div><div class="line">                        threadItem.setUpdateTime(latest_update_tm);</div><div class="line">                        FollowTopicDao.getInstance(context).updatePostsById(threadItem.getId(), count);</div><div class="line">                        listener.onUpdateThreadItem();</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (JSONException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 全部话题加载更多数据</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> listener</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadMoreAllTopic</span><span class="params">(Context context, Map&lt;String, String&gt; paramMap, <span class="keyword">final</span> OnLoadTopicListListener listener)</span> </span>&#123;</div><div class="line">        AsyncHttpRequest.doASynGetRequest(context, UrlContainer.TOPIC_LIST, (HashMap&lt;String, String&gt;) paramMap, <span class="keyword">true</span>, <span class="keyword">new</span> AsyncHttpRequest.CallBack() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fail</span><span class="params">(String ret)</span> </span>&#123;</div><div class="line">                listener.onFailure(Net.ErrorNo.NO_DATA);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String data)</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    ArrayList&lt;TopicItem&gt; items = (ArrayList&lt;TopicItem&gt;) TopicListDataParseUtils.readMoreAllTopic(data, listener);</div><div class="line">                    <span class="keyword">if</span> (items != <span class="keyword">null</span>) &#123;</div><div class="line">                        listener.onLoadMoreAllTopics(items);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (JSONException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                    listener.onFailure(Net.ErrorNo.ERROR_JSON);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnLoadTopicListListener</span> </span>&#123;</div><div class="line">        <span class="comment">//加载话题列表首页数据成功</span></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(List&lt;TopicItem&gt; list)</span></span>;</div><div class="line"></div><div class="line">        <span class="comment">//加载话题列表首页数据失败</span></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="keyword">int</span> erroNo)</span></span>;</div><div class="line"></div><div class="line">        <span class="comment">//全部话题加载更多相关配置</span></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onLoadMoreSwipeUp</span><span class="params">(SwipeUpItem item)</span></span>;</div><div class="line"></div><div class="line">        <span class="comment">//回去加载更多数据</span></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onLoadMoreAllTopics</span><span class="params">(List&lt;TopicItem&gt; list)</span></span>;</div><div class="line"></div><div class="line">        <span class="comment">//更新我关注的话题的相关数据</span></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onUpdateThreadItem</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br><font color="#C4573C" size="3" face="黑体">TopicPresenterImpl</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * DES：</span></div><div class="line"><span class="comment"> * Created by sushuai on 2016/4/13.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicPresenterImpl</span> <span class="keyword">implements</span> <span class="title">TopicPresenter</span>, <span class="title">TopicModelImpl</span>.<span class="title">OnLoadTopicListListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"TopicPresenterImpl"</span>;</div><div class="line">    <span class="keyword">private</span> TopicModel mTopicModel;</div><div class="line">    <span class="keyword">private</span> TopicView mTopicView;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TopicPresenterImpl</span><span class="params">(TopicView topicView)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mTopicModel = <span class="keyword">new</span> TopicModelImpl();</div><div class="line">        <span class="keyword">this</span>.mTopicView = topicView;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadTopicList</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        mTopicModel.loadTopicList(context, <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadMoreAllTopic</span><span class="params">(Context context, Map&lt;String, String&gt; paramMap)</span> </span>&#123;</div><div class="line">        mTopicModel.loadMoreAllTopic(context, paramMap, <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ArrayList&lt;TopicItem&gt; <span class="title">loadFollowTopic</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mTopicModel.loadFollowTopic(context,<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(List&lt;TopicItem&gt; list)</span> </span>&#123;</div><div class="line">        mTopicView.hideProgress();</div><div class="line">        mTopicView.addTopics(list);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="keyword">int</span> erroNo)</span> </span>&#123;</div><div class="line">        mTopicView.hideProgress();</div><div class="line">        mTopicView.showLoadFailMsg();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadMoreSwipeUp</span><span class="params">(SwipeUpItem item)</span> </span>&#123;</div><div class="line">        mTopicView.addSwipeUpItem(item);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadMoreAllTopics</span><span class="params">(List&lt;TopicItem&gt; list)</span> </span>&#123;</div><div class="line">        mTopicView.addLoadMoreTopics(list);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUpdateThreadItem</span><span class="params">()</span> </span>&#123;</div><div class="line">        mTopicView.notifyAdapter();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br><font color="#C4573C" size="3" face="黑体">TabTopicFragment</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 话题</span></div><div class="line"><span class="comment"> * SuShuai</span></div><div class="line"><span class="comment"> * 2016/4/12 14:39</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TabTopicFragment</span> <span class="keyword">extends</span> <span class="title">BaseFragment</span> <span class="keyword">implements</span> <span class="title">TopicAdapter</span>.<span class="title">AdapterCallback</span>, <span class="title">TopicView</span>, <span class="title">IHandlerMessage</span>, <span class="title">XListView</span>.<span class="title">IXListViewListener</span> </span>&#123;</div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> Rename parameter arguments, choose names that match</span></div><div class="line">    <span class="comment">// the fragment initialization parameters, e.g. ARG_ITEM_NUMBER</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"TabTopicFragment"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARG_PARAM1 = <span class="string">"param1"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARG_PARAM2 = <span class="string">"param2"</span>;</div><div class="line"></div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> Rename and change types of parameters</span></div><div class="line">    <span class="keyword">private</span> String mParam1;</div><div class="line">    <span class="keyword">private</span> String mParam2;</div><div class="line">    <span class="keyword">private</span> XListView listView;</div><div class="line">    <span class="keyword">private</span> TopicAdapter topicAdapter;</div><div class="line">    <span class="keyword">private</span> ArrayList&lt;TopicItem&gt; topicList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">private</span> ArrayList&lt;TopicItem&gt; homeList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">private</span> ArrayList&lt;TopicItem&gt; followTopicList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">private</span> TopicPresenter mTopicPresenter;</div><div class="line">    <span class="keyword">private</span> CommonHandler&lt;TabTopicFragment&gt; handler;</div><div class="line">    <span class="keyword">private</span> SwipeUpItem swipeUpItem;</div><div class="line">    <span class="keyword">private</span> View rootView;</div><div class="line">    <span class="keyword">private</span> String after = <span class="string">""</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TabTopicFragment</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Required empty public constructor</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Use this factory method to create a new instance of</span></div><div class="line"><span class="comment">     * this fragment using the provided parameters.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> param1 Parameter 1.</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> param2 Parameter 2.</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> A new instance of fragment TabTopicFragment.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> Rename and change types and number of parameters</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TabTopicFragment <span class="title">newInstance</span><span class="params">(String param1, String param2)</span> </span>&#123;</div><div class="line">        TabTopicFragment fragment = <span class="keyword">new</span> TabTopicFragment();</div><div class="line">        Bundle args = <span class="keyword">new</span> Bundle();</div><div class="line">        args.putString(ARG_PARAM1, param1);</div><div class="line">        args.putString(ARG_PARAM2, param2);</div><div class="line">        fragment.setArguments(args);</div><div class="line">        <span class="keyword">return</span> fragment;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttach</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onAttach(context);</div><div class="line">        LogHelper.e(TAG, <span class="string">"SuS--&gt; onAttach: "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        <span class="keyword">if</span> (getArguments() != <span class="keyword">null</span>) &#123;</div><div class="line">            mParam1 = getArguments().getString(ARG_PARAM1);</div><div class="line">            mParam2 = getArguments().getString(ARG_PARAM2);</div><div class="line">        &#125;</div><div class="line">        mTopicPresenter = <span class="keyword">new</span> TopicPresenterImpl(<span class="keyword">this</span>);</div><div class="line">        LogHelper.e(TAG, <span class="string">"SuS--&gt; onCreate: "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container,</span></span></div><div class="line"><span class="function"><span class="params">                             Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        LogHelper.e(TAG, <span class="string">"whb--&gt; onCreateView: "</span>);</div><div class="line">        <span class="keyword">if</span> (rootView == <span class="keyword">null</span>) &#123;</div><div class="line">            rootView = inflater.inflate(R.layout.fragment_tab_topic, container, <span class="keyword">false</span>);</div><div class="line">            initViews(rootView);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> rootView;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        LogHelper.e(TAG, <span class="string">"SuS--&gt; onActivityCreated: "</span>);</div><div class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</div><div class="line">        initData();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initData</span><span class="params">()</span> </span>&#123;</div><div class="line">        handler = <span class="keyword">new</span> CommonHandler&lt;TabTopicFragment&gt;(<span class="keyword">this</span>);</div><div class="line">        topicAdapter = <span class="keyword">new</span> TopicAdapter(getActivity(), <span class="keyword">this</span>);</div><div class="line">        listView.setAdapter(topicAdapter);</div><div class="line">        <span class="keyword">if</span> (NetUtils.isNetworkAvaliable(getActivity())) &#123;</div><div class="line">            showLoadingView();</div><div class="line">            mTopicPresenter.loadTopicList(getActivity());</div><div class="line">            followTopicList = mTopicPresenter.loadFollowTopic(getActivity());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (topicList.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">                topicAdapter.update(topicList);</div><div class="line">                ToastUtils.toast(getActivity(), <span class="string">"没有网络"</span>);</div><div class="line">                listView.restListView();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            showNetErroView(R.string.tips_net_error);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initViews</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        setImmerseLayout(v.findViewById(R.id.common_back));</div><div class="line">        setTitleBar(v, R.string.tab_topic);</div><div class="line">        setLeftGone(v);</div><div class="line">        listView = (XListView) v.findViewById(R.id.lv_topic);</div><div class="line">        listView.setPullRefreshEnable(<span class="keyword">true</span>);</div><div class="line">        listView.setPullLoadEnable(<span class="keyword">true</span>);</div><div class="line">        listView.setAutoLoadEnable(<span class="keyword">true</span>);</div><div class="line">        listView.setXListViewListener(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAdapterCallback</span><span class="params">(<span class="keyword">int</span> eventId, Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isAdded()) &#123;</div><div class="line">            BaofengStatistics.onUmengEvent(getActivity(), BfCountConst.TopicConst.BBS_MOREFOLLOW_CLICK);</div><div class="line">            LogHelper.v(<span class="string">"umeng"</span>, <span class="string">"bbs_morefollow_click  计数一次"</span>);</div><div class="line">        &#125;</div><div class="line">        ActivityUtil.startActivity(getActivity(), MoreFollowTopicActivity.class, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showProgress</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTopics</span><span class="params">(List&lt;TopicItem&gt; topicList)</span> </span>&#123;</div><div class="line">        handler.obtainMessage(HandlerMsg.MSG_LOAD_TOPIC_LIST_SUC,</div><div class="line">                topicList).sendToTarget();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSwipeUpItem</span><span class="params">(SwipeUpItem item)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (item == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        handler.obtainMessage(HandlerMsg.MSG_LOAD_SWIPE_UP_ITEM,</div><div class="line">                item).sendToTarget();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLoadMoreTopics</span><span class="params">(List&lt;TopicItem&gt; topicList)</span> </span>&#123;</div><div class="line">        handler.obtainMessage(HandlerMsg.MSG_LOAD_MORE_TOPICS,</div><div class="line">                topicList).sendToTarget();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hideProgress</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// handler.obtainMessage(HandlerMsg.MSG_DISMISS_LOADING).sendToTarget();</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showLoadFailMsg</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (topicList == <span class="keyword">null</span> || topicList.size() == <span class="number">0</span>) &#123;</div><div class="line">            handler.obtainMessage(HandlerMsg.MSG_SHOW_EMPTY_CONTENT).sendToTarget();</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            handler.obtainMessage(HandlerMsg.MSG_SHOW_FAIL).sendToTarget();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyAdapter</span><span class="params">()</span> </span>&#123;</div><div class="line">        handler.obtainMessage(HandlerMsg.MSG_NOTIFY_ADAPTER_CONTENT).sendToTarget();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerCallback</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">            <span class="keyword">case</span> HandlerMsg.MSG_LOAD_TOPIC_LIST_SUC:</div><div class="line">                dealTopicListSuc(msg);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> HandlerMsg.MSG_LOAD_SWIPE_UP_ITEM:</div><div class="line">                SwipeUpItem item = (SwipeUpItem) msg.obj;</div><div class="line">                <span class="keyword">this</span>.swipeUpItem = item;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> HandlerMsg.MSG_LOAD_MORE_TOPICS:</div><div class="line">                dealLoadMoreTopics(msg);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> HandlerMsg.MSG_DISMISS_LOADING:</div><div class="line">                dismissLoadingView();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> HandlerMsg.MSG_SHOW_EMPTY_CONTENT:</div><div class="line">                showContentEmptyView();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> HandlerMsg.MSG_NOTIFY_ADAPTER_CONTENT:</div><div class="line">                topicAdapter.notifyDataSetChanged();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> HandlerMsg.MSG_SHOW_FAIL:</div><div class="line">                ToastUtils.toast(getActivity(),R.string.error_no);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dealLoadMoreTopics</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        List&lt;TopicItem&gt; moreList = (List&lt;TopicItem&gt;) msg.obj;</div><div class="line">        <span class="keyword">int</span> count1 = listView.getLastVisiblePosition();</div><div class="line">        <span class="keyword">int</span> count2 = topicAdapter.getCount()-<span class="number">1</span>+<span class="number">2</span>;</div><div class="line">        <span class="keyword">if</span> (moreList.size() &lt; swipeUpItem.getLimit() &amp;&amp; count1 == count2) &#123;</div><div class="line">            ToastUtils.toast(getActivity(), <span class="string">"已到达底部"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (moreList.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            after = TabTopicUtil.getLastKey(moreList);</div><div class="line">        &#125;</div><div class="line">        TabTopicUtil.filterDuplicatedTopic(moreList,homeList);</div><div class="line">        <span class="keyword">this</span>.topicList.addAll(moreList);</div><div class="line">        topicAdapter.update(<span class="keyword">this</span>.topicList);</div><div class="line">        listView.restListView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dealTopicListSuc</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        List&lt;TopicItem&gt; topicList = (List&lt;TopicItem&gt;) msg.obj;</div><div class="line">        <span class="keyword">if</span> (topicList.size() &lt;= <span class="number">0</span>) &#123;</div><div class="line">            showContentEmptyView();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        after = TabTopicUtil.getLastKey(topicList);</div><div class="line">        TabTopicUtil.removeDuplicateWithOrder(topicList);</div><div class="line">        topicList.addAll(<span class="number">0</span>,followTopicList);</div><div class="line">        <span class="keyword">this</span>.topicList = (ArrayList&lt;TopicItem&gt;) topicList;</div><div class="line">        <span class="keyword">this</span>.homeList = (ArrayList&lt;TopicItem&gt;) topicList;</div><div class="line">        topicAdapter.update(topicList);</div><div class="line">        dismissLoadingView();</div><div class="line">        listView.restListView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//handler.postDelayed(new Runnable() &#123;</span></div><div class="line">        <span class="comment">// @Override</span></div><div class="line">        <span class="comment">//public void run() &#123;</span></div><div class="line">        <span class="keyword">if</span> (NetUtils.isNetworkAvaliable(getActivity())) &#123;</div><div class="line">            mTopicPresenter.loadTopicList(getActivity());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (topicList.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">                ToastUtils.toast(getActivity(), <span class="string">"没有网络"</span>);</div><div class="line">                listView.restListView();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            showNetErroView(R.string.tips_net_error);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// &#125;</span></div><div class="line">        <span class="comment">//&#125;, 2000);</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadMore</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        handler.postDelayed(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                Map&lt;String, String&gt; m = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">                <span class="keyword">int</span> size = topicList.size();</div><div class="line">                <span class="keyword">if</span> (size &lt;= <span class="number">0</span>)</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                m.put(Net.Param.ID, String.valueOf(swipeUpItem.getId()));</div><div class="line">                m.put(Net.Param.AFTER, after);</div><div class="line">                m.put(Net.Param.LIMIT, String.valueOf(swipeUpItem.getLimit()));</div><div class="line">                <span class="keyword">if</span> (NetUtils.isNetworkAvaliable(getActivity())) &#123;</div><div class="line">                    mTopicPresenter.loadMoreAllTopic(getActivity(), m);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    ToastUtils.toast(getActivity(), <span class="string">"没有网络"</span>);</div><div class="line">                    listView.restListView();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;, <span class="number">500</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</div><div class="line">            <span class="keyword">case</span> R.id.fragment_net_error_subTree:</div><div class="line">                reQuestData();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 重新请求数据</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reQuestData</span><span class="params">()</span> </span>&#123;</div><div class="line">        dismissNetErroView();</div><div class="line">        dismissContentEmptyView();</div><div class="line">        <span class="keyword">if</span> (NetUtils.isNetworkAvaliable(getActivity())) &#123;</div><div class="line">            showLoadingView();</div><div class="line">            mTopicPresenter.loadTopicList(getActivity());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            showNetErroView(R.string.tips_net_error);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerMsg</span> </span>&#123;</div><div class="line">        <span class="comment">//获取话题列表成功</span></div><div class="line">        <span class="keyword">int</span> MSG_LOAD_TOPIC_LIST_SUC = <span class="number">2002</span>;</div><div class="line">        <span class="comment">//获取加载更多配置选项</span></div><div class="line">        <span class="keyword">int</span> MSG_LOAD_SWIPE_UP_ITEM = <span class="number">2003</span>;</div><div class="line">        <span class="comment">//加载更多话题</span></div><div class="line">        <span class="keyword">int</span> MSG_LOAD_MORE_TOPICS = <span class="number">2004</span>;</div><div class="line">        <span class="comment">//隐藏loading</span></div><div class="line">        <span class="keyword">int</span> MSG_DISMISS_LOADING = <span class="number">2005</span>;</div><div class="line">        <span class="comment">//显示空</span></div><div class="line">        <span class="keyword">int</span> MSG_SHOW_EMPTY_CONTENT = <span class="number">2006</span>;</div><div class="line">        <span class="comment">//二次请求刷新界面</span></div><div class="line">        <span class="keyword">int</span> MSG_NOTIFY_ADAPTER_CONTENT = <span class="number">2007</span>;</div><div class="line">        <span class="comment">//显示失败</span></div><div class="line">        <span class="keyword">int</span> MSG_SHOW_FAIL = <span class="number">2008</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroyView</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="comment">//        unbindDrawables(getView());</span></div><div class="line">        LogHelper.e(TAG, <span class="string">"whb--&gt; onDestroyView: "</span>);</div><div class="line">        <span class="keyword">super</span>.onDestroyView();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onResume();</div><div class="line">        LogHelper.d(TAG, <span class="string">"SuS--&gt; onResume: "</span>);</div><div class="line">            BaofengStatistics.onUmengEvent(getActivity(), BfCountConst.TopicConst.BBS_CHANNELLIST_SHOW);</div><div class="line">            LogHelper.v(<span class="string">"umeng"</span>, <span class="string">"bbs_channelList_show  计数一次"</span>);</div><div class="line">        topicList.removeAll(followTopicList);</div><div class="line">        followTopicList = mTopicPresenter.loadFollowTopic(getActivity());</div><div class="line">        topicList.addAll(<span class="number">0</span>,followTopicList);</div><div class="line">        topicAdapter.notifyDataSetChanged();</div><div class="line">        <span class="comment">//initData();</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>## <font color="#C4573C" size="5" face="黑体">MVP与MVC的异同</font><br> MVC模式与MVP模式都作为用来分离UI层与业务层的一种开发模式被应用了很多年。在我们选择一种开发模式时，首先需要了解一下这种模式的利弊：<br><br> 无论MVC或是MVP模式都不可避免地存如下弊端，这就导致了这两种开发模式也许并不是很小型应用。<br>         &gt;<em>  额外的代码复杂度和学习成本<br><br>但比起他们的优点，这点弊端基本可以忽略了：<br>      &gt;</em> 降低耦合度<br>      &gt;<em> 模块职责划分明显<br>      &gt;</em>  利于测试驱动开发<br>      &gt;<em> 代码复用<br>      &gt;</em> 隐藏数据<br>      &gt;<em> 代码灵活性<br><br> 对于MVP与MVC这两种模式，它们之间也有很大的差异。以下是这两种模式之间最关键的差异：<br>     MVP模式：<br>&gt;</em> View不直接与Model交互，而是通过与Presenter交互来与Model间接交互<br>&gt;<em> Presenter与View的交互是通过接口来进行的，更有利于添加单元测试<br>&gt;</em> 通常View与Presenter是一对一的，但复杂的View可能绑定多个Presenter来处理逻辑<br><br>MVC模式：<br>&gt;<em> View可以与Model直接交互<br>&gt;</em> Controller是基于行为的，并且可以被多个View共享<br>&gt;* 可以负责决定显示哪个View<br># <font color="#C4573C" size="5" face="黑体">MVVM</font><br><img src="http://img.blog.csdn.net/20160513113127889" alt="这里写图片描述"><br><img src="http://img.blog.csdn.net/20160513113209084" alt="这里写图片描述"><br># <font color="#C4573C" size="5" face="黑体">Data-Binding</font><br>## <font color="#C4573C" size="4" face="黑体">前言</font>

<blockquote>
<ul>
<li>第三方的数据绑定框架随时有停止更新的风险，官方的则相对更稳定一些</li>
<li>大量的findViewById，增加代码的耦合性</li>
<li>虽然可以通过注解框架抛弃大量的findViewById，但是注解注定要拖慢我们代码的速度，Data Binding则不会，官网文档说还会提高解析XML的速度</li>
</ul>
</blockquote>
<p>这里不赘述了，下面几篇文章都讲的很详细！</p>
<p><a href="https://github.com/LyndonChin/MasteringAndroidDataBinding/" target="_blank" rel="external">精通 Android Data Binding</a><br> <a href="http://blog.csdn.net/qibin0506/article/details/47393725" target="_blank" rel="external">Android官方数据绑定框架DataBinding(一)</a><br> <a href="http://blog.csdn.net/qibin0506/article/details/47720125" target="_blank" rel="external">Android官方数据绑定框架DataBinding(二)</a><br><a href="https://developer.android.com/topic/libraries/data-binding/index.html#build_environment" target="_blank" rel="external">官方Data Binding Library</a></p>
<h2 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a><font color="#C4573C" size="4" face="黑体">参考链接：</font></h2><p>1、<a href="https://www.zhihu.com/question/21406685" target="_blank" rel="external">https://www.zhihu.com/question/21406685</a><br>2、<a href="http://liuling123.com/2015/12/mvp-pattern-android.html" target="_blank" rel="external">http://liuling123.com/2015/12/mvp-pattern-android.html</a><br>3、<a href="http://www.2cto.com/kf/201506/405766.html" target="_blank" rel="external">http://www.2cto.com/kf/201506/405766.html</a><br>4、<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0313/2599.html" target="_blank" rel="external">http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0313/2599.html</a><br>5、<a href="http://blog.csdn.net/qibin0506/article/details/47393725" target="_blank" rel="external">http://blog.csdn.net/qibin0506/article/details/47393725</a><br>6、<a href="http://zjutkz.net/2016/04/13/%E9%80%89%E6%8B%A9%E6%81%90%E6%83%A7%E7%97%87%E7%9A%84%E7%A6%8F%E9%9F%B3%EF%BC%81%E6%95%99%E4%BD%A0%E8%AE%A4%E6%B8%85MVC%EF%BC%8CMVP%E5%92%8CMVVM/#plg_nld=1&amp;plg_auth=1&amp;plg_nld=1&amp;plg_dev=1&amp;plg_uin=1&amp;plg_usr=1&amp;plg_vkey=1&amp;plg_nld=1&amp;more?hmsr=toutiao.io&amp;utm_source=toutiao.io&amp;plg_uin=1&amp;plg_auth=1&amp;utm_medium=toutiao.io&amp;plg_dev=1&amp;plg_nld=1&amp;plg_usr=1&amp;plg_vkey=1" target="_blank" rel="external">http://zjutkz.net/2016/04/13/%E9%80%89%E6%8B%A9%E6%81%90%E6%83%A7%E7%97%87%E7%9A%84%E7%A6%8F%E9%9F%B3%EF%BC%81%E6%95%99%E4%BD%A0%E8%AE%A4%E6%B8%85MVC%EF%BC%8CMVP%E5%92%8CMVVM/#plg_nld=1&amp;plg_auth=1&amp;plg_nld=1&amp;plg_dev=1&amp;plg_uin=1&amp;plg_usr=1&amp;plg_vkey=1&amp;plg_nld=1&amp;more?hmsr=toutiao.io&amp;utm_source=toutiao.io&amp;plg_uin=1&amp;plg_auth=1&amp;utm_medium=toutiao.io&amp;plg_dev=1&amp;plg_nld=1&amp;plg_usr=1&amp;plg_vkey=1</a><br>7、<a href="http://blog.csdn.net/wusuopubupt/article/details/8817826" target="_blank" rel="external">http://blog.csdn.net/wusuopubupt/article/details/8817826</a><br>8、<a href="https://github.com/LyndonChin/MasteringAndroidDataBinding\" target="_blank" rel="external">https://github.com/LyndonChin/MasteringAndroidDataBinding\</a><br>9、<a href="https://github.com/googlesamples/android-architecture" target="_blank" rel="external">https://github.com/googlesamples/android-architecture</a><br>10、<a href="http://www.jianshu.com/p/569ab68da482" target="_blank" rel="external">http://www.jianshu.com/p/569ab68da482</a><br>11、<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0425/4178.html" target="_blank" rel="external">http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0425/4178.html</a><br>12、<a href="http://blog.csdn.net/vector_yi/article/details/24719873" target="_blank" rel="external">http://blog.csdn.net/vector_yi/article/details/24719873</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/27/Android Architecture（Is Activity God？）/" itemprop="url">
                  Android Architecture（Is Activity God？）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-27T10:12:00+08:00" content="2016-05-27">
              2016-05-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/27/Android Architecture（Is Activity God？）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/27/Android Architecture（Is Activity God？）/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="分享MVC、MVP、MVVM和Data-Binding的简要PPT"><a href="#分享MVC、MVP、MVVM和Data-Binding的简要PPT" class="headerlink" title="分享MVC、MVP、MVVM和Data-Binding的简要PPT"></a>分享MVC、MVP、MVVM和Data-Binding的简要PPT</h2><p><img src="http://img.blog.csdn.net/20160523232126227" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232149915" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232222367" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232233101" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232243148" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232252805" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232303352" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232316180" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232325680" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232337231" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232356434" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232420294" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232440842" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160523232451045" alt="这里写图片描述"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/25/DroidPlugin插件化应用分析/" itemprop="url">
                  DroidPlugin插件化应用分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-25T14:08:00+08:00" content="2016-04-25">
              2016-04-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/25/DroidPlugin插件化应用分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/25/DroidPlugin插件化应用分析/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#C4573C" size="5" face="黑体">简介</font></h2><p>DroidPlugin 是360手机助手在Android系统上实现的一种新的插件机制:它可以在无需安装、修改的情况下运行APK文件,此机制对改进大型APP的架构，实现多团队协作开发具有一定的好处<br>详情请查看DroidPlugin的<a href="https://github.com/Qihoo360/DroidPlugin" target="_blank" rel="external">github地址</a></p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a><font color="#C4573C" size="5" face="黑体">背景</font></h2><blockquote>
<ul>
<li>将项目中某个相对独立的功能模块分解出来</li>
<li>例如：语音搜索功能模块独立出来，这样减少了项目中依赖包的数量，减少了项目中某些包的层层依赖关系，将语音搜索模块独立成一个单独的apk</li>
<li>可以独立开发语音搜索模块</li>
<li>假设主项目为Host，依赖library为DroidPlugin，独立出来的语音模块生成为voice.apk</li>
</ul>
</blockquote>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a><font color="#C4573C" size="5" face="黑体">应用</font></h2><p> 这里将独立出来的语音搜索模块打包成单独的apk，放在项目的assets目录下</p>
<p>项目中的设置步骤：</p>
<blockquote>
<ul>
<li>导入DroidPlugin相关的library</li>
<li><p>在自己的Application当中添加如下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> <span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate();</div><div class="line">    <span class="comment">//这里必须在super.onCreate方法之后，顺序不能变</span></div><div class="line">    PluginHelper.getInstance().applicationOnCreate(getBaseContext());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</div><div class="line">    PluginHelper.getInstance().applicationAttachBaseContext(base);</div><div class="line">    <span class="keyword">super</span>.attachBaseContext(base);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>配置主应用AndroidManifest.xml中相关的组件和权限<br>这里需要注意DroidPlugin library中需要的权限以及组件要在主项目Host中声明<br>还有就是Host中的权限只能比voice的多，不能少，否则会有问题</p>
</li>
<li>读取assets里面的voice.apk并复制到sd上或者其他的可读取存储位置，然后再使用DroidPlugin进行安装，这里将需要用到的一些方法封装在PluginUtils工具类中。</li>
<li><p>当voice.apk通过插件式的形式安装完成以后，我们就可以通过如下方式启动voice.apk</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PluginUtils.startActivity(SearchResultActivity.<span class="keyword">this</span>,<span class="string">"com.storm.smart.voice"</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>在Application或者MainActivty中加载voice.apk</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * 通过DroidPlugin插件安装voice.apk</span></div><div class="line"><span class="comment">    * 从sd卡根目录读取</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">droidPluginInstall</span><span class="params">()</span> </span>&#123;</div><div class="line">       BfExecutor.getInstance().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">               <span class="meta">@Override</span></div><div class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                   <span class="keyword">if</span> (PluginUtils.copyApkFromAssets(getApplicationContext(), <span class="string">"voice.apk"</span>,</div><div class="line">                           Environment.getExternalStorageDirectory().getAbsolutePath() + <span class="string">"/voice.apk"</span>)) &#123;</div><div class="line">                       PluginUtils.installApk(getApplicationContext(),</div><div class="line">                               Environment.getExternalStorageDirectory().getAbsolutePath() + <span class="string">"/voice.apk"</span>,</div><div class="line">                               <span class="string">"com.storm.smart.voice"</span>);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 通过DroidPlugin插件安装voice.apk</span></div><div class="line"><span class="comment"> * 从data下读取，需要权限（有可能手机没有sd卡）</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">droidPluginInstall</span><span class="params">()</span> </span>&#123;</div><div class="line">	BfExecutor.getInstance().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			String path = <span class="string">"/data/data/"</span> + getApplicationContext().getPackageName() + <span class="string">"/files"</span> + <span class="string">"/voice.apk"</span>;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				String command = <span class="string">"chmod "</span> + <span class="string">"666"</span> + <span class="string">" "</span> + path;</div><div class="line">				Runtime runtime = Runtime.getRuntime();</div><div class="line">				runtime.exec(command);</div><div class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (PluginUtils.copyApkFromAssets(getApplicationContext(), <span class="string">"voice.apk"</span>, path)) &#123;</div><div class="line">				PluginUtils.installApk(getApplicationContext(), path, <span class="string">"com.storm.smart.voice"</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>PluginUtils全部代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginUtils</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Activity activity, String packageName)</span></span>&#123;</div><div class="line">        PackageManager pm = activity.getPackageManager();</div><div class="line">        Intent intent = pm.getLaunchIntentForPackage(packageName);</div><div class="line">        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">        activity.startActivity(intent);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 删除apk</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> activity</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> packageName</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">void</span> <span class="title">doUninstall</span><span class="params">( Activity activity, String packageName)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!PluginManager.getInstance().isConnected()) &#123;</div><div class="line">            Toast.makeText(activity, <span class="string">"服务未连接"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                PluginManager.getInstance().deletePackage(packageName, <span class="number">0</span>);</div><div class="line">                Toast.makeText(activity, <span class="string">"删除完成"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 应该在线程中安装，此方法仅供测试</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> activity</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> apkPath</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> packageName</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span>  <span class="title">installApk</span><span class="params">(Context context, String apkPath, String packageName)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!PluginManager.getInstance().isConnected()) &#123;</div><div class="line">            <span class="comment">//installTips(context,"插件服务正在初始化，请稍后再试。。。");</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (PluginManager.getInstance().getPackageInfo(packageName, <span class="number">0</span>) != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//installTips(context,"已经安装了，不能再安装");</span></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">int</span> re = PluginManager.getInstance().installPackage(apkPath, <span class="number">0</span>);</div><div class="line">               <span class="keyword">if</span>(re == PluginManager.INSTALL_FAILED_NO_REQUESTEDPERMISSION)&#123;</div><div class="line">                   <span class="comment">//安装失败，文件请求的权限太多</span></div><div class="line">                   <span class="comment">//installTips(context,"安装失败，文件请求的权限太多");</span></div><div class="line">               &#125;<span class="keyword">else</span>&#123;</div><div class="line">                   <span class="comment">//安装完成</span></div><div class="line">                   <span class="comment">//installTips(context,"安装完成");</span></div><div class="line">                   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;    </div><div class="line">    </div><div class="line">    <span class="comment">/**安装提示</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> tips</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">installTips</span><span class="params">(Context context,String tips)</span></span>&#123;</div><div class="line">    	 Looper.prepare();<span class="comment">//1、初始化Looper </span></div><div class="line">         Toast.makeText(context, tips, Toast.LENGTH_SHORT).show();</div><div class="line">         Looper.loop();<span class="comment">//4、启动消息循环</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/** 将assets文件下的apk读取到读取到指定路径</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> fileName</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> path</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">copyApkFromAssets</span><span class="params">(Context context, String fileName, String path)</span> </span>&#123;  </div><div class="line">        <span class="keyword">boolean</span> copyIsFinish = <span class="keyword">false</span>;  </div><div class="line">        <span class="keyword">try</span> &#123;  </div><div class="line">            InputStream is = context.getAssets().open(fileName);  </div><div class="line">            File file = <span class="keyword">new</span> File(path);  </div><div class="line">            file.createNewFile();  </div><div class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(file);  </div><div class="line">            <span class="keyword">byte</span>[] temp = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];  </div><div class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;  </div><div class="line">            <span class="keyword">while</span> ((i = is.read(temp)) &gt; <span class="number">0</span>) &#123;  </div><div class="line">                fos.write(temp, <span class="number">0</span>, i);  </div><div class="line">            &#125;  </div><div class="line">            fos.close();  </div><div class="line">            is.close();  </div><div class="line">            copyIsFinish = <span class="keyword">true</span>;  </div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </div><div class="line">            e.printStackTrace();  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">return</span> copyIsFinish;  </div><div class="line">    &#125;  </div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><font color="#C4573C" size="5" face="黑体">总结</font></h2><p>最终我们会发现在/data/data/【host packageName】下有一个Plugin文件夹，文件夹中有个【voice packageName】文件夹，里面有voice的相关数据<br>这样voice.apk就以插件的方式嵌入到我们的主应用中了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/05/移动支付（微信、支付宝、银联）集成/" itemprop="url">
                  移动支付（微信、支付宝、银联）集成
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-05T14:00:00+08:00" content="2016-04-05">
              2016-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/05/移动支付（微信、支付宝、银联）集成/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/05/移动支付（微信、支付宝、银联）集成/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h2 id="微信支付"><a href="#微信支付" class="headerlink" title="微信支付"></a><font color="#C4573C" size="5" face="黑体">微信支付</font></h2><h3 id="Demo一直返回-1"><a href="#Demo一直返回-1" class="headerlink" title="Demo一直返回-1"></a><font color="#C4573C" size="4" face="黑体">Demo一直返回-1</font></h3><p>先去官网下载demo运行，第一次可以支付成功，以后就一直返回-1<br>如果是以客户端的官网demo进行测试的话，若一直返回-1，可采用如下方式处理：</p>
<blockquote>
<ul>
<li>删除微信缓冲数据<br>按如下步骤：设置-&gt;应用程序管理器-&gt;微信-&gt;清除数据</li>
<li>使用demo里的debug.keystore来测试<br>功能修改步骤：preferences-&gt;android-&gt;build-&gt;custom debug keystore-&gt;browse。 <h3 id="集成之后总是返回-1"><a href="#集成之后总是返回-1" class="headerlink" title="集成之后总是返回-1"></a><font color="#C4573C" size="4" face="黑体">集成之后总是返回-1</font></h3>可能产生问题的地方：包名不一致等其它原因（按照集成申请步骤来，这个应该很少发生）<h3 id="Demo中的订单模拟"><a href="#Demo中的订单模拟" class="headerlink" title="Demo中的订单模拟"></a><font color="#C4573C" size="4" face="黑体">Demo中的订单模拟</font></h3>其实微信支付的大部分工作是需要服务器端进行完成，微信支付的demo中，帮我们模拟了通过服务器生成订单，并返回prepayid的过程，然后demo中会拿着这些微信给我们模拟好的数据去进行支付，每次测试会向”微信测试”支付0.01元。demo中毕竟是模拟的，我们自己的集成一定是实实在在的，不过这里我并不会涉及到太多关于服务器端需要做什么<h3 id="客户端快速集成"><a href="#客户端快速集成" class="headerlink" title="客户端快速集成"></a><font color="#C4573C" size="4" face="黑体">客户端快速集成</font></h3>微信支付的demo比较冗余，我们把支付需要的东西单独摘出来,画箭头的文件可以copy到自己的工程中，根据实际业务或者代码设计进行修改。另外需要注意如下几点：</li>
<li>AndroidManifest.xml中package名字和项目包名一样；</li>
<li>将WXPayEntryActivity.java放在package.wxapi/下面</li>
<li>AndroidManifest.xml中添加.wxapi.WXPayEntryActivity（不添加，支付成功后无法跳转到相应的通知Activity界面）；</li>
</ul>
</blockquote>
<p><img src="http://img.blog.csdn.net/20160202105552636" alt="这里写图片描述"></p>
<h3 id="集成关键步骤"><a href="#集成关键步骤" class="headerlink" title="集成关键步骤"></a><font color="#C4573C" size="4" face="黑体">集成关键步骤</font></h3><p>从实际开发的角度来看PayActivity中需要添加的三个必备参数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*****************************************************************</span></div><div class="line"><span class="comment"> * 微信支付需要的参数解释： APP_ID，商户号，API密钥</span></div><div class="line"><span class="comment">*****************************************************************/</span></div><div class="line"><span class="comment">// APP_ID</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String APP_ID = <span class="string">"xxxxxxxxxxxxxx"</span>;</div><div class="line"><span class="comment">// 商户号</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MCH_ID = <span class="string">"yyyyyyyyyyyyyy"</span>;</div><div class="line"><span class="comment">// API密钥，在商户平台设置</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String API_KEY = <span class="string">"zzzzzzzzzzzzz"</span>;</div><div class="line">IWXAPI msgApi ;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">...</div><div class="line">	msgApi = WXAPIFactory.createWXAPI(<span class="keyword">this</span>.getApplicationContext(), <span class="keyword">null</span>);</div><div class="line">   ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a><font color="#C4573C" size="4" face="黑体">基本流程</font></h4><blockquote>
<ul>
<li>点击微信支付-&gt;检测微信是否安装</li>
<li>未安装toast提示</li>
<li>已安装-&gt;根据需要兑换或者支付的产品id去服务器请求创建订单-&gt;创建订单成功-&gt;根据服务器返回的prepayid调用微信客户端进行微信支付-&gt;微信回调（无论成功、失败或者取消）-&gt;返回支付页面-&gt;去服务器校验订单-&gt;成功则根据校验结果进行相应业务跳转，校验异常可以强制用户进入订单列表页面进行再次比对校验（这个过程需要本地保存一下校验异常的订单，不过具体怎么处理校验异常可以自行制定策略）</li>
<li>一般校验订单是发生在微信客户端回调成功之后再去校验，但有一种情况也需要去校验，就是用户不是通过在微信中操作返回支付页面，而是通过home按键返回，这样支付页面就收不到微信的回调结果，即使已经支付成功，所以我们需要在支付页面回到前台的某个控制时机去再次校验一下订单</li>
<li>另外微信支付客户端的回调是在WXPayEntryActivity中完成的，这里可以自己再进一步封装处理</li>
</ul>
</blockquote>
<p>贴一些相关代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">	 * 微信支付使用</span></div><div class="line"><span class="comment">	 * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">genNonceStr</span><span class="params">()</span> </span>&#123;</div><div class="line">		Random random = <span class="keyword">new</span> Random();</div><div class="line">		<span class="keyword">return</span> MD5.getMessageDigest(String.valueOf(random.nextInt(<span class="number">10000</span>)).getBytes());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 微信安装检测</span></div><div class="line"><span class="comment">	 * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkApkExist</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (msgApi.isWXAppInstalled()) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 微信支付：调用微信支付</span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> prepayId 支付id</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">weiXinPay</span><span class="params">(String prepayId)</span> </span>&#123;</div><div class="line">		PayReq req = <span class="keyword">new</span> PayReq();</div><div class="line"></div><div class="line">		req.appId = APP_ID;</div><div class="line">		req.partnerId = MCH_ID;</div><div class="line">		req.prepayId = prepayId;</div><div class="line">		req.packageValue = <span class="string">"Sign=WXPay"</span>;</div><div class="line">		req.nonceStr = genNonceStr();</div><div class="line">		req.timeStamp = String.valueOf(System.currentTimeMillis() / <span class="number">1000</span>);</div><div class="line"></div><div class="line">		StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">		sb.append(<span class="string">"appid="</span>);</div><div class="line">		sb.append(req.appId);</div><div class="line">		sb.append(<span class="string">"&amp;noncestr="</span>);</div><div class="line">		sb.append(req.nonceStr);</div><div class="line">		sb.append(<span class="string">"&amp;package="</span>);</div><div class="line">		sb.append(req.packageValue);</div><div class="line">		sb.append(<span class="string">"&amp;partnerid="</span>);</div><div class="line">		sb.append(req.partnerId);</div><div class="line">		sb.append(<span class="string">"&amp;prepayid="</span>);</div><div class="line">		sb.append(req.prepayId);</div><div class="line">		sb.append(<span class="string">"&amp;timestamp="</span>);</div><div class="line">		sb.append(req.timeStamp);</div><div class="line">		sb.append(<span class="string">"&amp;key="</span>);</div><div class="line">		sb.append(API_KEY);</div><div class="line"></div><div class="line">		String appSign = MD5.getMessageDigest(sb.toString().getBytes()).toUpperCase();</div><div class="line"></div><div class="line">		req.sign = appSign;</div><div class="line">		msgApi.registerApp(APP_ID);</div><div class="line">		msgApi.sendReq(req);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<h2 id="支付宝支付"><a href="#支付宝支付" class="headerlink" title="支付宝支付"></a><font color="#C4573C" size="4" face="黑体">支付宝支付</font></h2><h3 id="集成过程"><a href="#集成过程" class="headerlink" title="集成过程"></a><font color="#C4573C" size="4" face="黑体">集成过程</font></h3><p>其实支付宝支付的集成更加简单<br><img src="http://img.blog.csdn.net/20160202112703880" alt="这里写图片描述"></p>
<p>支付宝支付的demo上来是不能运行的，因为你缺少需要的参数,这里列举的是客户端需要的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*****************************************************************</span></div><div class="line"><span class="comment"> * 支付宝支付需要的参数解释： 商户PID、商户收款账号、商户私钥</span></div><div class="line"><span class="comment">*****************************************************************/</span></div><div class="line"><span class="comment">// 商户PID</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PARTNER = <span class="string">"xxxxxxxxxxxxx"</span>;</div><div class="line"><span class="comment">// 商户收款账号</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SELLER = <span class="string">"yyyyyyyyyyy"</span>;</div><div class="line"><span class="comment">// 商户私钥，pkcs8格式</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RSA_PRIVATE = <span class="string">"zzzzzzzzz"</span>;</div></pre></td></tr></table></figure></p>
<p>配置文件中不要忘记加入：(否则当手机没有安装支付宝客户端时无法调用支付成功)<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">      <span class="comment">&lt;!-- alipay sdk begin --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">activity</span></span></div><div class="line"><span class="tag"><span class="attr">android:name</span>=<span class="string">"com.alipay.sdk.app.H5PayActivity"</span>            <span class="attr">android:configChanges</span>=<span class="string">"orientation|keyboardHidden|navigation|screenSize"</span></span></div><div class="line"><span class="tag"><span class="attr">android:exported</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag"><span class="attr">android:screenOrientation</span>=<span class="string">"behind"</span>            <span class="attr">android:windowSoftInputMode</span>=<span class="string">"adjustResize|stateHidden"</span> &gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- alipay sdk end --&gt;</span></div></pre></td></tr></table></figure></p>
<p>贴一下相关代码，较demo有些许改动:</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a><font color="#C4573C" size="4" face="黑体">注意事项</font></h3><p>需要注意的地方：</p>
<blockquote>
<ul>
<li>私钥一定配置正确，我看有好多小伙伴会在sign(orderInfo)时获得的sign为null,最终导致做URL编码的时候报空指针，我也碰到过，就是服务器那边给的RSA_PRIVATE有问题。公钥客户端用不着</li>
<li>微信支付只需要传递一个prepayid，而支付宝支付需要穿三个参数，一个是订单号，一个是价格，一个是notify_url</li>
<li>支付宝支付创建订单以及订单校验的过程与微信支付类似，因为同在一个地方，要控制好相应的逻辑</li>
<li>注意一下price的单位，分和元不要搞错了<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * call alipay sdk pay. 调用支付宝SDK支付</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">alipay</span><span class="params">(String tradeNo, String price, String notify_url)</span> </span>&#123;</div><div class="line">	<span class="comment">// 订单</span></div><div class="line">	<span class="comment">// String orderInfo = getOrderInfo("测试的商品", "该测试商品的详细描述", "0.01");</span></div><div class="line"></div><div class="line">	String orderInfo = getOrderInfo(tradeNo, title,</div><div class="line">			payInfo, price, notify_url);</div><div class="line">	<span class="comment">// 对订单做RSA 签名</span></div><div class="line">	String sign = sign(orderInfo);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 仅需对sign 做URL编码</span></div><div class="line">		sign = URLEncoder.encode(sign, <span class="string">"UTF-8"</span>);</div><div class="line">	&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 完整的符合支付宝参数规范的订单信息</span></div><div class="line">	<span class="keyword">final</span> String payInfo = orderInfo + <span class="string">"&amp;sign=\""</span> + sign + <span class="string">"\"&amp;"</span> + getSignType();</div><div class="line"></div><div class="line">	Runnable payRunnable = <span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="comment">// 构造PayTask 对象</span></div><div class="line">			PayTask alipay = <span class="keyword">new</span> PayTask(PayActivity.<span class="keyword">this</span>);</div><div class="line">			<span class="comment">// 调用支付接口，获取支付结果</span></div><div class="line">			String result = alipay.pay(payInfo);</div><div class="line"></div><div class="line">			Message msg = <span class="keyword">new</span> Message();</div><div class="line">			msg.what = SDK_PAY_FLAG;</div><div class="line">			msg.obj = result;</div><div class="line">			mHandler.sendMessage(msg);</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line"></div><div class="line">	<span class="comment">// 必须异步调用</span></div><div class="line">	ThreadPoolUtils.execute(payRunnable);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * create the order info. 创建支付宝订单信息</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getOrderInfo</span><span class="params">(String tradeNo, String subject, String body, String price, String notify_url)</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// 签约合作者身份ID</span></div><div class="line">	String orderInfo = <span class="string">"partner="</span> + <span class="string">"\""</span> + PARTNER + <span class="string">"\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 签约卖家支付宝账号</span></div><div class="line">	orderInfo += <span class="string">"&amp;seller_id="</span> + <span class="string">"\""</span> + SELLER + <span class="string">"\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 商户网站唯一订单号</span></div><div class="line">	orderInfo += <span class="string">"&amp;out_trade_no="</span> + <span class="string">"\""</span> + tradeNo + <span class="string">"\""</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!TextUtils.isEmpty(subject)) &#123;</div><div class="line">		<span class="comment">// 商品名称</span></div><div class="line">		orderInfo += <span class="string">"&amp;subject="</span> + <span class="string">"\""</span> + subject + <span class="string">"\""</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!TextUtils.isEmpty(body)) &#123;</div><div class="line">		<span class="comment">// 商品详情</span></div><div class="line">		orderInfo += <span class="string">"&amp;body="</span> + <span class="string">"\""</span> + body + <span class="string">"\""</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 商品金额</span></div><div class="line">	orderInfo += <span class="string">"&amp;total_fee="</span> + <span class="string">"\""</span> + (Integer.parseInt(price) / <span class="number">100f</span>) + <span class="string">"\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 服务器异步通知页面路径</span></div><div class="line">	orderInfo += <span class="string">"&amp;notify_url="</span> + <span class="string">"\""</span> + notify_url + <span class="string">"\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 服务接口名称， 固定值</span></div><div class="line">	orderInfo += <span class="string">"&amp;service=\"mobile.securitypay.pay\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 支付类型， 固定值</span></div><div class="line">	orderInfo += <span class="string">"&amp;payment_type=\"1\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 参数编码， 固定值</span></div><div class="line">	orderInfo += <span class="string">"&amp;_input_charset=\"utf-8\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 设置未付款交易的超时时间</span></div><div class="line">	<span class="comment">// 默认30分钟，一旦超时，该笔交易就会自动被关闭。</span></div><div class="line">	<span class="comment">// 取值范围：1m～15d。</span></div><div class="line">	<span class="comment">// m-分钟，h-小时，d-天，1c-当天（无论交易何时创建，都在0点关闭）。</span></div><div class="line">	<span class="comment">// 该参数数值不接受小数点，如1.5h，可转换为90m。</span></div><div class="line">	orderInfo += <span class="string">"&amp;it_b_pay=\"30m\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// extern_token为经过快登授权获取到的alipay_open_id,带上此参数用户将使用授权的账户进行支付</span></div><div class="line">	<span class="comment">// orderInfo += "&amp;extern_token=" + "\"" + extern_token + "\"";</span></div><div class="line"></div><div class="line">	<span class="comment">// 支付宝处理完请求后，当前页面跳转到商户指定页面的路径，可空</span></div><div class="line">	orderInfo += <span class="string">"&amp;return_url=\"m.alipay.com\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 调用银行卡支付，需配置此参数，参与签名， 固定值 （需要签约《无线银行卡快捷支付》才能使用）</span></div><div class="line">	<span class="comment">// orderInfo += "&amp;paymethod=\"expressGateway\"";</span></div><div class="line"></div><div class="line">	<span class="keyword">return</span> orderInfo;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 支付宝支付使用 sign the order info. 对订单信息进行签名</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> content</span></div><div class="line"><span class="comment"> *            待签名订单信息</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">sign</span><span class="params">(String content)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> SignUtils.sign(content, RSA_PRIVATE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 支付宝支付使用 get the sign type we use. 获取签名方式</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getSignType</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="string">"sign_type=\"RSA\""</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<p>支付宝支付成功的回调(收到的msg.what为SDK_PAY_FLAG)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">	 * 支付宝支付客户端回调成功</span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> msg</span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> theLayout</span></div><div class="line"><span class="comment">     */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">aliSdkPaySuc</span><span class="params">(Message msg, PayActivity theLayout)</span> </span>&#123;</div><div class="line">		PayResult payResult = <span class="keyword">new</span> PayResult((String) msg.obj);</div><div class="line">		<span class="comment">// 支付宝返回此次支付结果及加签，建议对支付宝签名信息拿签约时支付宝提供的公钥做验签</span></div><div class="line">		String resultInfo = payResult.getResult();</div><div class="line">		String resultStatus = payResult.getResultStatus();</div><div class="line"></div><div class="line">		<span class="comment">// 判断resultStatus 为“9000”则代表支付成功，具体状态码代表含义可参考接口文档</span></div><div class="line">		<span class="keyword">if</span> (TextUtils.equals(resultStatus, <span class="string">"9000"</span>)) &#123;</div><div class="line">            <span class="comment">/*Toast.makeText(theLayout, "支付成功",</span></div><div class="line"><span class="comment">                    Toast.LENGTH_SHORT).show();*/</span></div><div class="line">            theLayout.payCheck();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 判断resultStatus 为非“9000”则代表可能支付失败</span></div><div class="line">            <span class="comment">// “8000”代表支付结果因为支付渠道原因或者系统原因还在等待支付结果确认，最终交易是否成功以服务端异步通知为准（小概率状态）</span></div><div class="line">            <span class="keyword">if</span> (TextUtils.equals(resultStatus, <span class="string">"8000"</span>)) &#123;</div><div class="line">                Toast.makeText(theLayout, <span class="string">"支付结果确认中"</span>,</div><div class="line">                        Toast.LENGTH_SHORT).show();</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TextUtils.equals(resultStatus, <span class="string">"4000"</span>)) &#123;</div><div class="line">                <span class="comment">// 其他值就可以判断为支付失败，包括用户主动取消支付，或者系统返回的错误</span></div><div class="line">                Toast.makeText(theLayout, <span class="string">"支付失败"</span>,</div><div class="line">                        Toast.LENGTH_SHORT).show();</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(TextUtils.equals(resultStatus, <span class="string">"6001"</span>))&#123;</div><div class="line">                theLayout.payCount(<span class="string">"5"</span>,<span class="string">""</span>);</div><div class="line">                Toast.makeText(theLayout, <span class="string">"支付取消"</span>,</div><div class="line">                        Toast.LENGTH_SHORT).show();</div><div class="line"></div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(TextUtils.equals(resultStatus, <span class="string">"6002"</span>))&#123;</div><div class="line">                Toast.makeText(theLayout, <span class="string">"网络连接出错"</span>,</div><div class="line">                        Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">		theLayout.clickAliPay = <span class="keyword">false</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<h2 id="银联支付"><a href="#银联支付" class="headerlink" title="银联支付"></a><font color="#C4573C" size="5" face="黑体">银联支付</font></h2><p><a href="https://open.unionpay.com/ajweb/help/file/techFile?cateLog=Development_kit" target="_blank" rel="external">银联商家技术服务SDK下载地址</a><br><img src="http://img.blog.csdn.net/20160202140958653" alt="Drawing" width="250px"></p>
<p>##<font color="#C4573C" size="5" face="黑体">小结</font></p>
<blockquote>
<ul>
<li>关于微信支付和支付宝支付的坑，上面已经介绍很多了，如果还有问题的话，可以参考一下官方的FAQ </li>
<li>集成起来整体感觉支付宝支付要比微信支付容易点 </li>
<li>微信支付可以支付虚拟货币，但是支付宝需要走特殊通道开通 </li>
<li>银联支付暂时没做，因为商家账户申请的时间好长 </li>
<li>移动支付的过程处理需要在逻辑上做到严谨（对各种异常要提前预判），毕竟是跟钱有关的<br><img src="http://img.blog.csdn.net/20160202150907574" alt="这里写图片描述"></li>
</ul>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="SuS" />
          <p class="site-author-name" itemprop="name">SuS</p>
          <p class="site-description motion-element" itemprop="description">手掌一散，流落走多少时光</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">12</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/soulrelay" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/s003603u" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-csdn"></i>
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SuS</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"soulrelay"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
