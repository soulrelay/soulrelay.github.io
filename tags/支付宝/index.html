<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Tag: 支付宝 | SuS&#39;s Blog</title>
  <meta name="description" content="手掌一散，流落走多少时光" />
  <meta name="keywords" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/">
  <link rel="alternate" href="/atom.xml" title="SuS's Blog">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="手掌一散，流落走多少时光">
<meta property="og:type" content="website">
<meta property="og:title" content="SuS&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/tags/支付宝/index.html">
<meta property="og:site_name" content="SuS&#39;s Blog">
<meta property="og:description" content="手掌一散，流落走多少时光">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SuS&#39;s Blog">
<meta name="twitter:description" content="手掌一散，流落走多少时光">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href='//cdn.bootcss.com/node-waves/0.7.5/waves.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				SuS's Blog
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-gallery' href='https://photos.google.com/album/AF1QipNoqKYgspQo5O1YhlFXGCQ7p575KBH3Yxf8WHL4?hl=zh-CN'>
								Gallery
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="https://photos.google.com/album/AF1QipNoqKYgspQo5O1YhlFXGCQ7p575KBH3Yxf8WHL4?hl=zh-CN" class="nav-gallery nav">
				Gallery
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        
  <script>
    window.subData= { title:'Tag : 支付宝'}
  </script>

<section class="post-list">
	
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/2016/04/05/移动支付（微信、支付宝、银联）集成/">
        移动支付（微信、支付宝、银联）集成
      </a>
    </h2>
    
    <time>
      Apr 5, 2016
    </time>
		
    
    <div class='cats'>
        <a href="/categories/Android/">Android</a>
    </div>

  </section>
  <section class="article typo">
	  <p>[TOC]</p>
<h2 id="微信支付"><a href="#微信支付" class="headerlink" title="微信支付"></a><font color="#C4573C" size="5" face="黑体">微信支付</font></h2><h3 id="Demo一直返回-1"><a href="#Demo一直返回-1" class="headerlink" title="Demo一直返回-1"></a><font color="#C4573C" size="4" face="黑体">Demo一直返回-1</font></h3><p>先去官网下载demo运行，第一次可以支付成功，以后就一直返回-1<br>如果是以客户端的官网demo进行测试的话，若一直返回-1，可采用如下方式处理：</p>
<blockquote>
<ul>
<li>删除微信缓冲数据<br>按如下步骤：设置-&gt;应用程序管理器-&gt;微信-&gt;清除数据</li>
<li>使用demo里的debug.keystore来测试<br>功能修改步骤：preferences-&gt;android-&gt;build-&gt;custom debug keystore-&gt;browse。 <h3 id="集成之后总是返回-1"><a href="#集成之后总是返回-1" class="headerlink" title="集成之后总是返回-1"></a><font color="#C4573C" size="4" face="黑体">集成之后总是返回-1</font></h3>可能产生问题的地方：包名不一致等其它原因（按照集成申请步骤来，这个应该很少发生）<h3 id="Demo中的订单模拟"><a href="#Demo中的订单模拟" class="headerlink" title="Demo中的订单模拟"></a><font color="#C4573C" size="4" face="黑体">Demo中的订单模拟</font></h3>其实微信支付的大部分工作是需要服务器端进行完成，微信支付的demo中，帮我们模拟了通过服务器生成订单，并返回prepayid的过程，然后demo中会拿着这些微信给我们模拟好的数据去进行支付，每次测试会向”微信测试”支付0.01元。demo中毕竟是模拟的，我们自己的集成一定是实实在在的，不过这里我并不会涉及到太多关于服务器端需要做什么<h3 id="客户端快速集成"><a href="#客户端快速集成" class="headerlink" title="客户端快速集成"></a><font color="#C4573C" size="4" face="黑体">客户端快速集成</font></h3>微信支付的demo比较冗余，我们把支付需要的东西单独摘出来,画箭头的文件可以copy到自己的工程中，根据实际业务或者代码设计进行修改。另外需要注意如下几点：</li>
<li>AndroidManifest.xml中package名字和项目包名一样；</li>
<li>将WXPayEntryActivity.java放在package.wxapi/下面</li>
<li>AndroidManifest.xml中添加.wxapi.WXPayEntryActivity（不添加，支付成功后无法跳转到相应的通知Activity界面）；</li>
</ul>
</blockquote>
<p><img src="http://img.blog.csdn.net/20160202105552636" alt="这里写图片描述"></p>
<h3 id="集成关键步骤"><a href="#集成关键步骤" class="headerlink" title="集成关键步骤"></a><font color="#C4573C" size="4" face="黑体">集成关键步骤</font></h3><p>从实际开发的角度来看PayActivity中需要添加的三个必备参数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*****************************************************************</span></div><div class="line"><span class="comment"> * 微信支付需要的参数解释： APP_ID，商户号，API密钥</span></div><div class="line"><span class="comment">*****************************************************************/</span></div><div class="line"><span class="comment">// APP_ID</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String APP_ID = <span class="string">"xxxxxxxxxxxxxx"</span>;</div><div class="line"><span class="comment">// 商户号</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MCH_ID = <span class="string">"yyyyyyyyyyyyyy"</span>;</div><div class="line"><span class="comment">// API密钥，在商户平台设置</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String API_KEY = <span class="string">"zzzzzzzzzzzzz"</span>;</div><div class="line">IWXAPI msgApi ;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">...</div><div class="line">	msgApi = WXAPIFactory.createWXAPI(<span class="keyword">this</span>.getApplicationContext(), <span class="keyword">null</span>);</div><div class="line">   ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a><font color="#C4573C" size="4" face="黑体">基本流程</font></h4><blockquote>
<ul>
<li>点击微信支付-&gt;检测微信是否安装</li>
<li>未安装toast提示</li>
<li>已安装-&gt;根据需要兑换或者支付的产品id去服务器请求创建订单-&gt;创建订单成功-&gt;根据服务器返回的prepayid调用微信客户端进行微信支付-&gt;微信回调（无论成功、失败或者取消）-&gt;返回支付页面-&gt;去服务器校验订单-&gt;成功则根据校验结果进行相应业务跳转，校验异常可以强制用户进入订单列表页面进行再次比对校验（这个过程需要本地保存一下校验异常的订单，不过具体怎么处理校验异常可以自行制定策略）</li>
<li>一般校验订单是发生在微信客户端回调成功之后再去校验，但有一种情况也需要去校验，就是用户不是通过在微信中操作返回支付页面，而是通过home按键返回，这样支付页面就收不到微信的回调结果，即使已经支付成功，所以我们需要在支付页面回到前台的某个控制时机去再次校验一下订单</li>
<li>另外微信支付客户端的回调是在WXPayEntryActivity中完成的，这里可以自己再进一步封装处理</li>
</ul>
</blockquote>
<p>贴一些相关代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">	 * 微信支付使用</span></div><div class="line"><span class="comment">	 * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">genNonceStr</span><span class="params">()</span> </span>&#123;</div><div class="line">		Random random = <span class="keyword">new</span> Random();</div><div class="line">		<span class="keyword">return</span> MD5.getMessageDigest(String.valueOf(random.nextInt(<span class="number">10000</span>)).getBytes());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 微信安装检测</span></div><div class="line"><span class="comment">	 * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkApkExist</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (msgApi.isWXAppInstalled()) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 微信支付：调用微信支付</span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> prepayId 支付id</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">weiXinPay</span><span class="params">(String prepayId)</span> </span>&#123;</div><div class="line">		PayReq req = <span class="keyword">new</span> PayReq();</div><div class="line"></div><div class="line">		req.appId = APP_ID;</div><div class="line">		req.partnerId = MCH_ID;</div><div class="line">		req.prepayId = prepayId;</div><div class="line">		req.packageValue = <span class="string">"Sign=WXPay"</span>;</div><div class="line">		req.nonceStr = genNonceStr();</div><div class="line">		req.timeStamp = String.valueOf(System.currentTimeMillis() / <span class="number">1000</span>);</div><div class="line"></div><div class="line">		StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">		sb.append(<span class="string">"appid="</span>);</div><div class="line">		sb.append(req.appId);</div><div class="line">		sb.append(<span class="string">"&amp;noncestr="</span>);</div><div class="line">		sb.append(req.nonceStr);</div><div class="line">		sb.append(<span class="string">"&amp;package="</span>);</div><div class="line">		sb.append(req.packageValue);</div><div class="line">		sb.append(<span class="string">"&amp;partnerid="</span>);</div><div class="line">		sb.append(req.partnerId);</div><div class="line">		sb.append(<span class="string">"&amp;prepayid="</span>);</div><div class="line">		sb.append(req.prepayId);</div><div class="line">		sb.append(<span class="string">"&amp;timestamp="</span>);</div><div class="line">		sb.append(req.timeStamp);</div><div class="line">		sb.append(<span class="string">"&amp;key="</span>);</div><div class="line">		sb.append(API_KEY);</div><div class="line"></div><div class="line">		String appSign = MD5.getMessageDigest(sb.toString().getBytes()).toUpperCase();</div><div class="line"></div><div class="line">		req.sign = appSign;</div><div class="line">		msgApi.registerApp(APP_ID);</div><div class="line">		msgApi.sendReq(req);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<h2 id="支付宝支付"><a href="#支付宝支付" class="headerlink" title="支付宝支付"></a><font color="#C4573C" size="4" face="黑体">支付宝支付</font></h2><h3 id="集成过程"><a href="#集成过程" class="headerlink" title="集成过程"></a><font color="#C4573C" size="4" face="黑体">集成过程</font></h3><p>其实支付宝支付的集成更加简单<br><img src="http://img.blog.csdn.net/20160202112703880" alt="这里写图片描述"></p>
<p>支付宝支付的demo上来是不能运行的，因为你缺少需要的参数,这里列举的是客户端需要的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*****************************************************************</span></div><div class="line"><span class="comment"> * 支付宝支付需要的参数解释： 商户PID、商户收款账号、商户私钥</span></div><div class="line"><span class="comment">*****************************************************************/</span></div><div class="line"><span class="comment">// 商户PID</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PARTNER = <span class="string">"xxxxxxxxxxxxx"</span>;</div><div class="line"><span class="comment">// 商户收款账号</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SELLER = <span class="string">"yyyyyyyyyyy"</span>;</div><div class="line"><span class="comment">// 商户私钥，pkcs8格式</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RSA_PRIVATE = <span class="string">"zzzzzzzzz"</span>;</div></pre></td></tr></table></figure></p>
<p>配置文件中不要忘记加入：(否则当手机没有安装支付宝客户端时无法调用支付成功)<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">      <span class="comment">&lt;!-- alipay sdk begin --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">activity</span></span></div><div class="line"><span class="tag"><span class="attr">android:name</span>=<span class="string">"com.alipay.sdk.app.H5PayActivity"</span>            <span class="attr">android:configChanges</span>=<span class="string">"orientation|keyboardHidden|navigation|screenSize"</span></span></div><div class="line"><span class="tag"><span class="attr">android:exported</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag"><span class="attr">android:screenOrientation</span>=<span class="string">"behind"</span>            <span class="attr">android:windowSoftInputMode</span>=<span class="string">"adjustResize|stateHidden"</span> &gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- alipay sdk end --&gt;</span></div></pre></td></tr></table></figure></p>
<p>贴一下相关代码，较demo有些许改动:</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a><font color="#C4573C" size="4" face="黑体">注意事项</font></h3><p>需要注意的地方：</p>
<blockquote>
<ul>
<li>私钥一定配置正确，我看有好多小伙伴会在sign(orderInfo)时获得的sign为null,最终导致做URL编码的时候报空指针，我也碰到过，就是服务器那边给的RSA_PRIVATE有问题。公钥客户端用不着</li>
<li>微信支付只需要传递一个prepayid，而支付宝支付需要穿三个参数，一个是订单号，一个是价格，一个是notify_url</li>
<li>支付宝支付创建订单以及订单校验的过程与微信支付类似，因为同在一个地方，要控制好相应的逻辑</li>
<li>注意一下price的单位，分和元不要搞错了<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * call alipay sdk pay. 调用支付宝SDK支付</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">alipay</span><span class="params">(String tradeNo, String price, String notify_url)</span> </span>&#123;</div><div class="line">	<span class="comment">// 订单</span></div><div class="line">	<span class="comment">// String orderInfo = getOrderInfo("测试的商品", "该测试商品的详细描述", "0.01");</span></div><div class="line"></div><div class="line">	String orderInfo = getOrderInfo(tradeNo, title,</div><div class="line">			payInfo, price, notify_url);</div><div class="line">	<span class="comment">// 对订单做RSA 签名</span></div><div class="line">	String sign = sign(orderInfo);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 仅需对sign 做URL编码</span></div><div class="line">		sign = URLEncoder.encode(sign, <span class="string">"UTF-8"</span>);</div><div class="line">	&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 完整的符合支付宝参数规范的订单信息</span></div><div class="line">	<span class="keyword">final</span> String payInfo = orderInfo + <span class="string">"&amp;sign=\""</span> + sign + <span class="string">"\"&amp;"</span> + getSignType();</div><div class="line"></div><div class="line">	Runnable payRunnable = <span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="comment">// 构造PayTask 对象</span></div><div class="line">			PayTask alipay = <span class="keyword">new</span> PayTask(PayActivity.<span class="keyword">this</span>);</div><div class="line">			<span class="comment">// 调用支付接口，获取支付结果</span></div><div class="line">			String result = alipay.pay(payInfo);</div><div class="line"></div><div class="line">			Message msg = <span class="keyword">new</span> Message();</div><div class="line">			msg.what = SDK_PAY_FLAG;</div><div class="line">			msg.obj = result;</div><div class="line">			mHandler.sendMessage(msg);</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line"></div><div class="line">	<span class="comment">// 必须异步调用</span></div><div class="line">	ThreadPoolUtils.execute(payRunnable);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * create the order info. 创建支付宝订单信息</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getOrderInfo</span><span class="params">(String tradeNo, String subject, String body, String price, String notify_url)</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// 签约合作者身份ID</span></div><div class="line">	String orderInfo = <span class="string">"partner="</span> + <span class="string">"\""</span> + PARTNER + <span class="string">"\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 签约卖家支付宝账号</span></div><div class="line">	orderInfo += <span class="string">"&amp;seller_id="</span> + <span class="string">"\""</span> + SELLER + <span class="string">"\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 商户网站唯一订单号</span></div><div class="line">	orderInfo += <span class="string">"&amp;out_trade_no="</span> + <span class="string">"\""</span> + tradeNo + <span class="string">"\""</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!TextUtils.isEmpty(subject)) &#123;</div><div class="line">		<span class="comment">// 商品名称</span></div><div class="line">		orderInfo += <span class="string">"&amp;subject="</span> + <span class="string">"\""</span> + subject + <span class="string">"\""</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!TextUtils.isEmpty(body)) &#123;</div><div class="line">		<span class="comment">// 商品详情</span></div><div class="line">		orderInfo += <span class="string">"&amp;body="</span> + <span class="string">"\""</span> + body + <span class="string">"\""</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 商品金额</span></div><div class="line">	orderInfo += <span class="string">"&amp;total_fee="</span> + <span class="string">"\""</span> + (Integer.parseInt(price) / <span class="number">100f</span>) + <span class="string">"\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 服务器异步通知页面路径</span></div><div class="line">	orderInfo += <span class="string">"&amp;notify_url="</span> + <span class="string">"\""</span> + notify_url + <span class="string">"\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 服务接口名称， 固定值</span></div><div class="line">	orderInfo += <span class="string">"&amp;service=\"mobile.securitypay.pay\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 支付类型， 固定值</span></div><div class="line">	orderInfo += <span class="string">"&amp;payment_type=\"1\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 参数编码， 固定值</span></div><div class="line">	orderInfo += <span class="string">"&amp;_input_charset=\"utf-8\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 设置未付款交易的超时时间</span></div><div class="line">	<span class="comment">// 默认30分钟，一旦超时，该笔交易就会自动被关闭。</span></div><div class="line">	<span class="comment">// 取值范围：1m～15d。</span></div><div class="line">	<span class="comment">// m-分钟，h-小时，d-天，1c-当天（无论交易何时创建，都在0点关闭）。</span></div><div class="line">	<span class="comment">// 该参数数值不接受小数点，如1.5h，可转换为90m。</span></div><div class="line">	orderInfo += <span class="string">"&amp;it_b_pay=\"30m\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// extern_token为经过快登授权获取到的alipay_open_id,带上此参数用户将使用授权的账户进行支付</span></div><div class="line">	<span class="comment">// orderInfo += "&amp;extern_token=" + "\"" + extern_token + "\"";</span></div><div class="line"></div><div class="line">	<span class="comment">// 支付宝处理完请求后，当前页面跳转到商户指定页面的路径，可空</span></div><div class="line">	orderInfo += <span class="string">"&amp;return_url=\"m.alipay.com\""</span>;</div><div class="line"></div><div class="line">	<span class="comment">// 调用银行卡支付，需配置此参数，参与签名， 固定值 （需要签约《无线银行卡快捷支付》才能使用）</span></div><div class="line">	<span class="comment">// orderInfo += "&amp;paymethod=\"expressGateway\"";</span></div><div class="line"></div><div class="line">	<span class="keyword">return</span> orderInfo;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 支付宝支付使用 sign the order info. 对订单信息进行签名</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> content</span></div><div class="line"><span class="comment"> *            待签名订单信息</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">sign</span><span class="params">(String content)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> SignUtils.sign(content, RSA_PRIVATE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 支付宝支付使用 get the sign type we use. 获取签名方式</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getSignType</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="string">"sign_type=\"RSA\""</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<p>支付宝支付成功的回调(收到的msg.what为SDK_PAY_FLAG)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">	 * 支付宝支付客户端回调成功</span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> msg</span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> theLayout</span></div><div class="line"><span class="comment">     */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">aliSdkPaySuc</span><span class="params">(Message msg, PayActivity theLayout)</span> </span>&#123;</div><div class="line">		PayResult payResult = <span class="keyword">new</span> PayResult((String) msg.obj);</div><div class="line">		<span class="comment">// 支付宝返回此次支付结果及加签，建议对支付宝签名信息拿签约时支付宝提供的公钥做验签</span></div><div class="line">		String resultInfo = payResult.getResult();</div><div class="line">		String resultStatus = payResult.getResultStatus();</div><div class="line"></div><div class="line">		<span class="comment">// 判断resultStatus 为“9000”则代表支付成功，具体状态码代表含义可参考接口文档</span></div><div class="line">		<span class="keyword">if</span> (TextUtils.equals(resultStatus, <span class="string">"9000"</span>)) &#123;</div><div class="line">            <span class="comment">/*Toast.makeText(theLayout, "支付成功",</span></div><div class="line"><span class="comment">                    Toast.LENGTH_SHORT).show();*/</span></div><div class="line">            theLayout.payCheck();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 判断resultStatus 为非“9000”则代表可能支付失败</span></div><div class="line">            <span class="comment">// “8000”代表支付结果因为支付渠道原因或者系统原因还在等待支付结果确认，最终交易是否成功以服务端异步通知为准（小概率状态）</span></div><div class="line">            <span class="keyword">if</span> (TextUtils.equals(resultStatus, <span class="string">"8000"</span>)) &#123;</div><div class="line">                Toast.makeText(theLayout, <span class="string">"支付结果确认中"</span>,</div><div class="line">                        Toast.LENGTH_SHORT).show();</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TextUtils.equals(resultStatus, <span class="string">"4000"</span>)) &#123;</div><div class="line">                <span class="comment">// 其他值就可以判断为支付失败，包括用户主动取消支付，或者系统返回的错误</span></div><div class="line">                Toast.makeText(theLayout, <span class="string">"支付失败"</span>,</div><div class="line">                        Toast.LENGTH_SHORT).show();</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(TextUtils.equals(resultStatus, <span class="string">"6001"</span>))&#123;</div><div class="line">                theLayout.payCount(<span class="string">"5"</span>,<span class="string">""</span>);</div><div class="line">                Toast.makeText(theLayout, <span class="string">"支付取消"</span>,</div><div class="line">                        Toast.LENGTH_SHORT).show();</div><div class="line"></div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(TextUtils.equals(resultStatus, <span class="string">"6002"</span>))&#123;</div><div class="line">                Toast.makeText(theLayout, <span class="string">"网络连接出错"</span>,</div><div class="line">                        Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">		theLayout.clickAliPay = <span class="keyword">false</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<h2 id="银联支付"><a href="#银联支付" class="headerlink" title="银联支付"></a><font color="#C4573C" size="5" face="黑体">银联支付</font></h2><p><a href="https://open.unionpay.com/ajweb/help/file/techFile?cateLog=Development_kit" target="_blank" rel="external">银联商家技术服务SDK下载地址</a><br><img src="http://img.blog.csdn.net/20160202140958653" alt="Drawing" width="250px"></p>
<p>##<font color="#C4573C" size="5" face="黑体">小结</font></p>
<blockquote>
<ul>
<li>关于微信支付和支付宝支付的坑，上面已经介绍很多了，如果还有问题的话，可以参考一下官方的FAQ </li>
<li>集成起来整体感觉支付宝支付要比微信支付容易点 </li>
<li>微信支付可以支付虚拟货币，但是支付宝需要走特殊通道开通 </li>
<li>银联支付暂时没做，因为商家账户申请的时间好长 </li>
<li>移动支付的过程处理需要在逻辑上做到严谨（对各种异常要提前预判），毕竟是跟钱有关的<br><img src="http://img.blog.csdn.net/20160202150907574" alt="这里写图片描述"></li>
</ul>
</blockquote>


    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/tags/移动支付/">移动支付</a>
      
        <a href="/tags/微信/">微信</a>
      
        <a href="/tags/支付宝/">支付宝</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
</section>


      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<div class='header'>SuS</div>
<div class='content'>
<div class='desc'>Tempora mutantur, nos et mutamur in illis ...</div>
</div>
</section>

  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="https://ccoooss.com">
            <div class='name'>ClassicOldSong</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="https://frantic1048.logdown.com/">
            <div class='name'>Frantic1048</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="https://hclmaster.github.io/">
            <div class='name'>Hclmaster</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="https://whst.github.io/">
            <div class='name'>WANG Hsü-Tung</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/Android/"><div class='name'>Android</div><div class='badget'>12</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/Android-Architecture/" style="font-size: 20px; color: #000">Android Architecture</a> <a href="/tags/EventBus/" style="font-size: 14px; color: #808080">EventBus</a> <a href="/tags/Jcenter/" style="font-size: 14px; color: #808080">Jcenter</a> <a href="/tags/Material-Design/" style="font-size: 14px; color: #808080">Material Design</a> <a href="/tags/Retrofit/" style="font-size: 14px; color: #808080">Retrofit</a> <a href="/tags/RxJava/" style="font-size: 14px; color: #808080">RxJava</a> <a href="/tags/StickyListHeaders/" style="font-size: 14px; color: #808080">StickyListHeaders</a> <a href="/tags/SwipeLayout/" style="font-size: 14px; color: #808080">SwipeLayout</a> <a href="/tags/SwipeToLoadLayout/" style="font-size: 14px; color: #808080">SwipeToLoadLayout</a> <a href="/tags/ToolBar/" style="font-size: 14px; color: #808080">ToolBar</a> <a href="/tags/View/" style="font-size: 20px; color: #000">View</a> <a href="/tags/view/" style="font-size: 14px; color: #808080">view</a> <a href="/tags/事件总线库/" style="font-size: 14px; color: #808080">事件总线库</a> <a href="/tags/微信/" style="font-size: 14px; color: #808080">微信</a> <a href="/tags/插件化/" style="font-size: 14px; color: #808080">插件化</a> <a href="/tags/支付宝/" style="font-size: 14px; color: #808080">支付宝</a> <a href="/tags/移动支付/" style="font-size: 14px; color: #808080">移动支付</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/stkevintan" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="https://twitter.com/kevinsfork" class="social twitter"
          target="_blank" rel="external">
          <span class="icon icon-twitter"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
